(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[384],{41723:function(e,r,t){Promise.resolve().then(t.bind(t,1661))},99376:function(e,r,t){"use strict";var a=t(35475);t.o(a,"notFound")&&t.d(r,{notFound:function(){return a.notFound}}),t.o(a,"useParams")&&t.d(r,{useParams:function(){return a.useParams}}),t.o(a,"usePathname")&&t.d(r,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(r,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(r,{useSearchParams:function(){return a.useSearchParams}})},1661:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return l}});var a=t(57437),n=t(2265),o=t(99376),s=t(5978),i=t(99764),c=t(71245),u=t(53459);function l(){let e=(0,o.useRouter)(),{user:r,companyId:t,role:l,loading:d}=(0,c.a)();return(0,n.useEffect)(()=>{if(!d){if(!r){e.replace("/login/usuario");return}(async()=>{let r;let a=(0,s.hJ)(i.N$,"obras");if("superadmin"===l)r=(0,s.IO)(a,(0,s.Xo)("creadoEn","desc"),(0,s.b9)(1));else if(t)r=(0,s.IO)(a,(0,s.ar)("empresaId","==",t),(0,s.Xo)("creadoEn","desc"),(0,s.b9)(1));else{e.replace("/obras");return}try{let t=await (0,s.PL)(r);if(t.empty)e.replace("/obras");else{let r=t.docs[0];e.replace("/rdi/".concat(r.id))}}catch(r){console.error("Error al buscar la obra m\xe1s reciente:",r),e.replace("/obras")}})()}},[r,t,l,d,e]),(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[400px]",children:[(0,a.jsx)(u.Z,{className:"h-8 w-8 animate-spin text-primary"}),(0,a.jsx)("p",{className:"mt-4 text-muted-foreground",children:"Buscando requerimientos..."})]})}},71245:function(e,r,t){"use strict";t.d(r,{H:function(){return f},a:function(){return m}});var a=t(57437),n=t(43301),o=t(2265),s=t(99764),i=t(99376),c=t(5978);async function u(e){var r;let t=s.N$,a=null===(r=e.email)||void 0===r?void 0:r.toLowerCase().trim();if(!a)return{role:"none",companyId:null};let n=(0,c.IO)((0,c.hJ)(t,"invitacionesUsuarios"),(0,c.ar)("email","==",a),(0,c.ar)("estado","==","pendiente_auth"),(0,c.b9)(1)),o=await (0,c.PL)(n);if(o.empty)return console.log("No hay invitaci\xf3n pendiente para ".concat(a,".")),{role:"none",companyId:null};let i=o.docs[0],u=i.data(),l=(0,c.JU)(t,"users",e.uid),d=(0,c.qs)(t);return d.set(l,{nombre:u.nombre||e.displayName,email:a,role:u.roleDeseado,empresaId:u.empresaId,activo:!0,createdAt:(0,c.Bt)(),updatedAt:(0,c.Bt)()},{merge:!0}),d.update(i.ref,{estado:"activado",uid:e.uid,activatedAt:(0,c.Bt)()}),await d.commit(),console.log("Usuario ".concat(a," activado con rol ").concat(u.roleDeseado," en empresa ").concat(u.empresaId,".")),{role:u.roleDeseado,companyId:u.empresaId}}async function l(e){}let d=(0,o.createContext)(void 0);function f(e){let{children:r}=e,[t,f]=(0,o.useState)(null),[m,p]=(0,o.useState)("none"),[h,v]=(0,o.useState)(null),[w,b]=(0,o.useState)(null),[y,g]=(0,o.useState)(!0),E=(0,i.useRouter)(),I=(0,i.usePathname)();async function P(e,r){try{await (0,n.e5)(s.lX,e,r)}catch(e){if("auth/invalid-credential"===e.code||"auth/wrong-password"===e.code||"auth/user-not-found"===e.code)throw Error("Credenciales inv\xe1lidas. Por favor, revisa tu correo y contrase\xf1a.");if("auth/too-many-requests"===e.code)throw Error("Demasiados intentos fallidos. Por seguridad, el acceso desde este dispositivo ha sido bloqueado temporalmente.");throw console.error("Error de login no manejado:",e),Error("Ocurri\xf3 un error inesperado al iniciar sesi\xf3n.")}}async function x(){try{await (0,n.w7)(s.lX),f(null),p("none"),v(null),b(null),E.push("/")}catch(e){console.error("Error al cerrar sesi\xf3n",e)}}return(0,o.useEffect)(()=>{let e=(0,n.Aj)(s.lX,async e=>{if(e){await l(e);let r=(0,c.JU)(s.N$,"users",e.uid),t=await (0,c.QT)(r),a="none",n=null,o=!1;if(t.exists()){let e=t.data();e.role&&void 0!==e.empresaId&&(a=e.role,n=e.empresaId,o=!0===e.mustChangePassword)}if("none"===a){let r=await u(e);a=r.role,n=r.companyId,o=!0}p(a),v(n),f(e);let i="/cambiar-password"===I;if(o&&!i)E.replace("/cambiar-password");else if(!o){if("none"===a)E.replace("/sin-acceso");else if(I.startsWith("/login")||"/"===I||i){let e="cliente"===a?"/cliente":"contratista"===a?"/cumplimiento/contratista":"/dashboard";E.replace(e)}}}else f(null),p("none"),v(null),b(null);g(!1)});return()=>e()},[E,I]),(0,o.useEffect)(()=>{if(h){let e=(0,c.JU)(s.N$,"companies",h),r=(0,n.Aj)(s.lX,r=>{r&&(0,c.QT)(e).then(e=>{e.exists()?b({id:e.id,...e.data()}):b(null)})});return()=>r()}b(null)},[h]),(0,a.jsx)(d.Provider,{value:{user:t,role:m,companyId:h,company:w,loading:y,login:P,logout:x},children:r})}function m(){let e=(0,o.useContext)(d);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}},99764:function(e,r,t){"use strict";let a,n,o,s,i;t.d(r,{IG:function(){return s},N$:function(){return o},lX:function(){return n},x2:function(){return i}});var c=t(738),u=t(43301),l=t(5978),d=t(60062),f=t(13491);let m={apiKey:"AIzaSyBfMp_dH9XhFSXEeMxY-Cdy8MDRIgWrxR0",authDomain:"pcg-2-8bf1b.firebaseapp.com",projectId:"pcg-2-8bf1b",storageBucket:"pcg-2-8bf1b.appspot.com",messagingSenderId:"1073834543546",appId:"1:1073834543546:web:2f85a4a8350280f8589737"};for(let e in m)if(Object.prototype.hasOwnProperty.call(m,e)&&!m[e]){let r=e.replace(/([A-Z])/g,"_$1").toUpperCase(),t="NEXT_PUBLIC_FIREBASE_".concat(r);throw Error("Error de configuraci\xf3n del cliente: La variable de entorno Firebase '".concat(t,"' no est\xe1 definida o est\xe1 vac\xeda. ")+"Aseg\xfarate de que est\xe9 configurada en tu archivo .env.local o en las variables de entorno de producci\xf3n.")}a=(0,c.C6)().length?(0,c.Mq)():(0,c.ZF)(m),n=(0,u.v0)(a),o=(0,l.ad)(a),s=(0,d.cF)(a),i=(0,f.$C)(a,"us-central1")},96471:function(e,r,t){"use strict";t.d(r,{Z:function(){return c}});var a=t(2265);let n=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),o=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.filter((e,r,t)=>!!e&&""!==e.trim()&&t.indexOf(e)===r).join(" ").trim()};var s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,a.forwardRef)((e,r)=>{let{color:t="currentColor",size:n=24,strokeWidth:i=2,absoluteStrokeWidth:c,className:u="",children:l,iconNode:d,...f}=e;return(0,a.createElement)("svg",{ref:r,...s,width:n,height:n,stroke:t,strokeWidth:c?24*Number(i)/Number(n):i,className:o("lucide",u),...f},[...d.map(e=>{let[r,t]=e;return(0,a.createElement)(r,t)}),...Array.isArray(l)?l:[l]])}),c=(e,r)=>{let t=(0,a.forwardRef)((t,s)=>{let{className:c,...u}=t;return(0,a.createElement)(i,{ref:s,iconNode:r,className:o("lucide-".concat(n(e)),c),...u})});return t.displayName="".concat(e),t}},53459:function(e,r,t){"use strict";t.d(r,{Z:function(){return a}});let a=(0,t(96471).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])}},function(e){e.O(0,[4358,9990,1211,2971,2117,1744],function(){return e(e.s=41723)}),_N_E=e.O()}]);