(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6161],{24780:function(e,t,r){Promise.resolve().then(r.bind(r,95636))},95636:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return j}});var a=r(57437),n=r(2265),s=r(99376),o=r(79820),i=r(12381),l=r(53459),u=r(5255),c=r(35465),d=r(25361),p=r(65887),m=r(5485),f=r(7204),v=r(1188),h=r(48614),x=r(5978),g=r(99764),y=r(71245),b=r(23340);function N(e){if("number"==typeof e)return e;if("string"!=typeof e||""===e.trim())return 0;let t=parseFloat(e.replace(/\$/g,"").replace(/\./g,"").replace(/,/g,".").trim());return isNaN(t)?0:t}function w(e){if(!e)return[];let t=["iva","total","subtotal","costo directo","costos directos","gastos generales","ggyu","utilidad","administraci\xf3n","imprevistos","neto","bruto"];return e.filter(e=>{var r,a,n,s;let o=(null!==(s=null!==(n=null!==(a=null!==(r=e.descripcion)&&void 0!==r?r:e.description)&&void 0!==a?a:e.nombre)&&void 0!==n?n:e.name)&&void 0!==s?s:"").trim().toLowerCase();return!!o&&!t.some(e=>o.includes(e))}).map(e=>{var t,r,a,n,s,o,i,l,u,c,d,p,m;let f;let v=null!==(n=null!==(a=null!==(r=null!==(t=e.descripcion)&&void 0!==t?t:e.description)&&void 0!==r?r:e.nombre)&&void 0!==a?a:e.name)&&void 0!==n?n:"",h=null!==(i=null!==(o=null!==(s=e.unidad)&&void 0!==s?s:e.unit)&&void 0!==o?o:e.u)&&void 0!==i?i:"",x=N(null!==(u=null!==(l=e.cantidad)&&void 0!==l?l:e.qty)&&void 0!==u?u:e.quantity),g=N(null!==(d=null!==(c=e.precioUnitario)&&void 0!==c?c:e.unitPrice)&&void 0!==d?d:e.price);return f=e.type&&["chapter","subchapter","item"].includes(e.type)?e.type:!0===e.isChapter||0===e.level?"chapter":!0===e.isSubchapter||1===e.level?"subchapter":"item",{parentId:null!==(m=null!==(p=e.parentId)&&void 0!==p?p:e.parent_id)&&void 0!==m?m:null,type:f,descripcion:v,unidad:h,cantidad:x,precioUnitario:g}})}function j(){let e=(0,s.useParams)(),t=(0,s.useRouter)(),{user:r,companyId:N}=(0,y.a)(),{toast:j}=(0,b.pm)(),I=e.jobId,[E,S]=(0,n.useState)(null),[A,C]=(0,n.useState)(0),[T,_]=(0,n.useState)(!1),[D,P]=(0,n.useState)(!1);(0,n.useEffect)(()=>{if(!I)return;let e=async()=>{try{let e=await fetch("/api/itemizados/importar/".concat(I));if(!e.ok)throw Error("No se pudo obtener el estado del trabajo.");let t=await e.json();S(t),"done"===t.status?C(100):"error"===t.status?C(100):"processing"===t.status&&C(e=>Math.min(e+5,90))}catch(e){S({status:"error",error:e.message})}};if((null==E?void 0:E.status)!=="done"&&(null==E?void 0:E.status)!=="error"){let t=setInterval(e,3e3);return()=>clearInterval(t)}},[I,null==E?void 0:E.status]);let O=async()=>{if(!(null==E?void 0:E.result)||!(null==E?void 0:E.obraId)||!r||!N){j({variant:"destructive",title:"Error",description:"No hay datos suficientes para guardar el presupuesto."});return}_(!0);try{var e,a,n,s,o,i,l;let u=null!==(i=null!==(o=null===(a=E.result)||void 0===a?void 0:null===(e=a.meta)||void 0===e?void 0:e.sourceFileName)&&void 0!==o?o:null==E?void 0:E.sourceFileName)&&void 0!==i?i:"Itemizado IA",c="Presupuesto importado de ".concat(u," - ").concat(new Date().toLocaleDateString()),d=w(null!==(l=null===(n=E.result)||void 0===n?void 0:n.rows)&&void 0!==l?l:[]),p=d.reduce((e,t)=>e+t.cantidad*t.precioUnitario,0),m={obraId:E.obraId,nombre:c,moneda:"CLP",observaciones:"Generado autom\xe1ticamente por IA a partir de un PDF. Job ID: ".concat(I,". ").concat((null===(s=E.result.meta)||void 0===s?void 0:s.notes)||""),gastosGeneralesPorcentaje:25,items:d,fechaCreacion:(0,x.Bt)(),updatedAt:(0,x.Bt)(),createdBy:r.uid,companyId:N,source:"IA_PDF",jobId:I,totalPresupuesto:p},f=await (0,x.ET)((0,x.hJ)(g.N$,"presupuestos"),m);j({title:"Presupuesto Guardado",description:"El presupuesto ha sido guardado correctamente."}),P(!0),t.push("/operaciones/presupuestos/".concat(f.id))}catch(e){console.error("Error saving presupuesto:",e),j({variant:"destructive",title:"Error al guardar",description:"No se pudo crear el documento de presupuesto. Detalles: ".concat(e.message)})}finally{_(!1)}};return(0,a.jsxs)("div",{className:"max-w-4xl mx-auto space-y-6",children:[(0,a.jsxs)(i.z,{variant:"outline",size:"sm",onClick:()=>t.push("/operaciones/presupuestos"),children:[(0,a.jsx)(m.Z,{className:"mr-2"})," Volver a Presupuestos"]}),(0,a.jsx)(o.Zb,{className:"min-h-[300px] flex items-center justify-center",children:(0,a.jsx)(o.aY,{className:"pt-6 w-full max-w-lg",children:(0,a.jsx)(h.M,{mode:"wait",children:(0,a.jsx)(v.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:(()=>{if(!E)return(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(l.Z,{className:"mx-auto h-12 w-12 animate-spin text-primary"}),(0,a.jsx)("p",{className:"mt-4 font-semibold",children:"Cargando estado del trabajo..."})]});switch(E.status){case"queued":return(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(l.Z,{className:"mx-auto h-12 w-12 animate-spin text-primary"}),(0,a.jsx)("p",{className:"mt-4 font-semibold",children:"En cola para an\xe1lisis..."}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Tu documento est\xe1 esperando ser procesado por la IA."})]});case"processing":return(0,a.jsxs)(v.E.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center",children:[(0,a.jsx)(l.Z,{className:"mx-auto h-12 w-12 animate-spin text-primary"}),(0,a.jsx)("p",{className:"mt-4 font-semibold",children:"Procesando con IA..."}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Analizando estructura y extrayendo datos. Esto puede tardar hasta 2 minutos."}),(0,a.jsx)(f.E,{value:A,className:"w-full max-w-sm mx-auto mt-4"})]});case"done":var e;return(0,a.jsxs)("div",{className:"text-center space-y-4",children:[(0,a.jsx)(u.Z,{className:"mx-auto h-12 w-12 text-green-500"}),(0,a.jsx)("p",{className:"mt-2 font-semibold text-xl",children:"\xa1An\xe1lisis completado!"}),E.result&&(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Se encontraron ",E.result.chapters.length," cap\xedtulos y ",w(null===(e=E.result)||void 0===e?void 0:e.rows).length," partidas v\xe1lidas."]}),(0,a.jsx)("div",{className:"mt-6 flex justify-center gap-4",children:(0,a.jsxs)(i.z,{onClick:O,disabled:T||D,children:[T?(0,a.jsx)(l.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,a.jsx)(c.Z,{className:"mr-2 h-4 w-4"}),D?"Guardado":T?"Guardando...":"REVISAR ITEMIZADO IA"]})})]});case"error":return(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(d.Z,{className:"mx-auto h-12 w-12 text-destructive"}),(0,a.jsx)("p",{className:"mt-4 font-semibold",children:"Error en el an\xe1lisis"}),(0,a.jsx)("p",{className:"text-sm text-destructive bg-destructive/10 p-2 rounded-md",children:E.error}),(0,a.jsxs)(i.z,{onClick:()=>t.push("/operaciones/presupuestos/itemizados/importar"),className:"mt-4",children:[(0,a.jsx)(p.Z,{className:"mr-2"})," Intentar de Nuevo"]})]});default:return null}})()},(null==E?void 0:E.status)||"loading")})})})]})}},12381:function(e,t,r){"use strict";r.d(t,{d:function(){return l},z:function(){return u}});var a=r(57437),n=r(2265),s=r(37053),o=r(90535),i=r(93448);let l=(0,o.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),u=n.forwardRef((e,t)=>{let{className:r,variant:n,size:o,asChild:u=!1,...c}=e,d=u?s.g7:"button";return(0,a.jsx)(d,{className:(0,i.cn)(l({variant:n,size:o,className:r})),ref:t,...c})});u.displayName="Button"},79820:function(e,t,r){"use strict";r.d(t,{Ol:function(){return i},SZ:function(){return u},Zb:function(){return o},aY:function(){return c},eW:function(){return d},ll:function(){return l}});var a=r(57437),n=r(2265),s=r(93448);let o=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",r),...n})});o.displayName="Card";let i=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",r),...n})});i.displayName="CardHeader";let l=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("text-2xl font-semibold leading-none tracking-tight",r),...n})});l.displayName="CardTitle";let u=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("text-sm text-muted-foreground",r),...n})});u.displayName="CardDescription";let c=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("p-6 pt-0",r),...n})});c.displayName="CardContent";let d=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("flex items-center p-6 pt-0",r),...n})});d.displayName="CardFooter"},7204:function(e,t,r){"use strict";r.d(t,{E:function(){return i}});var a=r(57437),n=r(2265),s=r(1505),o=r(93448);let i=n.forwardRef((e,t)=>{let{className:r,value:n,...i}=e;return(0,a.jsx)(s.fC,{ref:t,className:(0,o.cn)("relative h-4 w-full overflow-hidden rounded-full bg-secondary",r),...i,children:(0,a.jsx)(s.z$,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:"translateX(-".concat(100-(n||0),"%)")}})})});i.displayName=s.fC.displayName},71245:function(e,t,r){"use strict";r.d(t,{H:function(){return p},a:function(){return m}});var a=r(57437),n=r(43301),s=r(2265),o=r(99764),i=r(99376),l=r(5978);async function u(e){var t;let r=o.N$,a=null===(t=e.email)||void 0===t?void 0:t.toLowerCase().trim();if(!a)return{role:"none",companyId:null};let n=(0,l.IO)((0,l.hJ)(r,"invitacionesUsuarios"),(0,l.ar)("email","==",a),(0,l.ar)("estado","==","pendiente_auth"),(0,l.b9)(1)),s=await (0,l.PL)(n);if(s.empty)return console.log("No hay invitaci\xf3n pendiente para ".concat(a,".")),{role:"none",companyId:null};let i=s.docs[0],u=i.data(),c=(0,l.JU)(r,"users",e.uid),d=(0,l.qs)(r);return d.set(c,{nombre:u.nombre||e.displayName,email:a,role:u.roleDeseado,empresaId:u.empresaId,activo:!0,createdAt:(0,l.Bt)(),updatedAt:(0,l.Bt)()},{merge:!0}),d.update(i.ref,{estado:"activado",uid:e.uid,activatedAt:(0,l.Bt)()}),await d.commit(),console.log("Usuario ".concat(a," activado con rol ").concat(u.roleDeseado," en empresa ").concat(u.empresaId,".")),{role:u.roleDeseado,companyId:u.empresaId}}async function c(e){}let d=(0,s.createContext)(void 0);function p(e){let{children:t}=e,[r,p]=(0,s.useState)(null),[m,f]=(0,s.useState)("none"),[v,h]=(0,s.useState)(null),[x,g]=(0,s.useState)(null),[y,b]=(0,s.useState)(!0),N=(0,i.useRouter)(),w=(0,i.usePathname)();async function j(e,t){try{await (0,n.e5)(o.lX,e,t)}catch(e){if("auth/invalid-credential"===e.code||"auth/wrong-password"===e.code||"auth/user-not-found"===e.code)throw Error("Credenciales inv\xe1lidas. Por favor, revisa tu correo y contrase\xf1a.");if("auth/too-many-requests"===e.code)throw Error("Demasiados intentos fallidos. Por seguridad, el acceso desde este dispositivo ha sido bloqueado temporalmente.");throw console.error("Error de login no manejado:",e),Error("Ocurri\xf3 un error inesperado al iniciar sesi\xf3n.")}}async function I(){try{await (0,n.w7)(o.lX),p(null),f("none"),h(null),g(null),N.push("/")}catch(e){console.error("Error al cerrar sesi\xf3n",e)}}return(0,s.useEffect)(()=>{let e=(0,n.Aj)(o.lX,async e=>{if(e){await c(e);let t=(0,l.JU)(o.N$,"users",e.uid),r=await (0,l.QT)(t),a="none",n=null,s=!1;if(r.exists()){let e=r.data();e.role&&void 0!==e.empresaId&&(a=e.role,n=e.empresaId,s=!0===e.mustChangePassword)}if("none"===a){let t=await u(e);a=t.role,n=t.companyId,s=!0}f(a),h(n),p(e);let i="/cambiar-password"===w;if(s&&!i)N.replace("/cambiar-password");else if(!s){if("none"===a)N.replace("/sin-acceso");else if(w.startsWith("/login")||"/"===w||i){let e="cliente"===a?"/cliente":"contratista"===a?"/cumplimiento/contratista":"/dashboard";N.replace(e)}}}else p(null),f("none"),h(null),g(null);b(!1)});return()=>e()},[N,w]),(0,s.useEffect)(()=>{if(v){let e=(0,l.JU)(o.N$,"companies",v),t=(0,n.Aj)(o.lX,t=>{t&&(0,l.QT)(e).then(e=>{e.exists()?g({id:e.id,...e.data()}):g(null)})});return()=>t()}g(null)},[v]),(0,a.jsx)(d.Provider,{value:{user:r,role:m,companyId:v,company:x,loading:y,login:j,logout:I},children:t})}function m(){let e=(0,s.useContext)(d);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}},23340:function(e,t,r){"use strict";r.d(t,{pm:function(){return p}});var a=r(2265);let n=0,s=new Map,o=e=>{if(s.has(e))return;let t=setTimeout(()=>{s.delete(e),c({type:"REMOVE_TOAST",toastId:e})},1e6);s.set(e,t)},i=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:r}=t;return r?o(r):e.toasts.forEach(e=>{o(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===r||void 0===r?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},l=[],u={toasts:[]};function c(e){u=i(u,e),l.forEach(e=>{e(u)})}function d(e){let{...t}=e,r=(n=(n+1)%Number.MAX_SAFE_INTEGER).toString(),a=()=>c({type:"DISMISS_TOAST",toastId:r});return c({type:"ADD_TOAST",toast:{...t,id:r,open:!0,onOpenChange:e=>{e||a()}}}),{id:r,dismiss:a,update:e=>c({type:"UPDATE_TOAST",toast:{...e,id:r}})}}function p(){let[e,t]=a.useState(u);return a.useEffect(()=>(l.push(t),()=>{let e=l.indexOf(t);e>-1&&l.splice(e,1)}),[e]),{...e,toast:d,dismiss:e=>c({type:"DISMISS_TOAST",toastId:e})}}},99764:function(e,t,r){"use strict";let a,n,s,o,i;r.d(t,{IG:function(){return o},N$:function(){return s},lX:function(){return n},x2:function(){return i}});var l=r(738),u=r(43301),c=r(5978),d=r(60062),p=r(13491);let m={apiKey:"AIzaSyBfMp_dH9XhFSXEeMxY-Cdy8MDRIgWrxR0",authDomain:"pcg-2-8bf1b.firebaseapp.com",projectId:"pcg-2-8bf1b",storageBucket:"pcg-2-8bf1b.appspot.com",messagingSenderId:"1073834543546",appId:"1:1073834543546:web:2f85a4a8350280f8589737"};for(let e in m)if(Object.prototype.hasOwnProperty.call(m,e)&&!m[e]){let t=e.replace(/([A-Z])/g,"_$1").toUpperCase(),r="NEXT_PUBLIC_FIREBASE_".concat(t);throw Error("Error de configuraci\xf3n del cliente: La variable de entorno Firebase '".concat(r,"' no est\xe1 definida o est\xe1 vac\xeda. ")+"Aseg\xfarate de que est\xe9 configurada en tu archivo .env.local o en las variables de entorno de producci\xf3n.")}a=(0,l.C6)().length?(0,l.Mq)():(0,l.ZF)(m),n=(0,u.v0)(a),s=(0,c.ad)(a),o=(0,d.cF)(a),i=(0,p.$C)(a,"us-central1")},93448:function(e,t,r){"use strict";r.d(t,{cn:function(){return s}});var a=r(61994),n=r(53335);function s(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,n.m6)((0,a.W)(t))}}},function(e){e.O(0,[4358,9990,6137,1211,1188,3489,2971,2117,1744],function(){return e(e.s=24780)}),_N_E=e.O()}]);