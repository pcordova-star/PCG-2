(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6366],{71998:function(e,a,s){Promise.resolve().then(s.bind(s,17915))},17915:function(e,a,s){"use strict";s.r(a),s.d(a,{default:function(){return A}});var t=s(57437),i=s(2265),r=s(99376),n=s(12381),l=s(79820),c=s(17168),d=s(33804),o=s(40279),u=s(75060),x=s(74291),m=s(15291),h=s(30767),p=s(54233),j=s(15847),f=s(16942),g=s(86622),N=s(32508),v=s(43728),y=s(5485),b=s(5978),C=s(99764),z=s(23340),w=s(71245);function S(e){return isNaN(e)?"$ 0":e.toLocaleString("es-CL",{style:"currency",currency:"CLP"})}function I(){let{toast:e}=(0,z.pm)(),[a,s]=(0,i.useState)([]),[r,c]=(0,i.useState)(!0),[m,h]=(0,i.useState)(!1),[g,N]=(0,i.useState)(null),[v,y]=(0,i.useState)(!1),[w,I]=(0,i.useState)(!1),[k,A]=(0,i.useState)([]);(0,i.useEffect)(()=>{let a=(0,b.IO)((0,b.hJ)(C.N$,"catalogoItems"),(0,b.Xo)("codigo")),t=(0,b.cf)(a,e=>{s(e.docs.map(e=>({id:e.id,...e.data()}))),c(!1)},a=>{console.error("Error fetching catalog items: ",a),e({variant:"destructive",title:"Error",description:"No se pudieron cargar los \xedtems del cat\xe1logo."}),c(!1)});return()=>t()},[e]);let E=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;N(e||{codigo:"",descripcion:"",unidad:"UN",precioActual:0,categoria:""}),h(!0)},D=async s=>{if(s.preventDefault(),!g||!g.codigo||!g.descripcion){e({variant:"destructive",title:"Error de validaci\xf3n",description:"C\xf3digo y descripci\xf3n son obligatorios."});return}y(!0);let t=Number(g.precioActual)||0;try{let s=(0,b.qs)(C.N$);if(g.id){let e=(0,b.JU)(C.N$,"catalogoItems",g.id),i=a.find(e=>e.id===g.id);if(s.update(e,{...g,precioActual:t,fechaUltimoPrecio:(0,b.Bt)()}),i&&i.precioActual!==t){let e=(0,b.JU)((0,b.hJ)(C.N$,"historialPrecios"));s.set(e,{itemId:g.id,precio:t,fecha:(0,b.Bt)(),fuente:"Actualizaci\xf3n manual"})}}else{let e=(0,b.JU)((0,b.hJ)(C.N$,"catalogoItems"));s.set(e,{...g,precioActual:t,fechaUltimoPrecio:(0,b.Bt)()});let a=(0,b.JU)((0,b.hJ)(C.N$,"historialPrecios"));s.set(a,{itemId:e.id,precio:t,fecha:(0,b.Bt)(),fuente:"Creaci\xf3n de \xedtem"})}await s.commit(),e({title:"\xc9xito",description:"\xcdtem ".concat(g.id?"actualizado":"creado"," correctamente.")}),h(!1)}catch(a){console.error("Error saving item: ",a),e({variant:"destructive",title:"Error",description:"No se pudo guardar el \xedtem."})}finally{y(!1)}},P=async e=>{let s=(0,b.IO)((0,b.hJ)(C.N$,"historialPrecios"),(0,b.ar)("itemId","==",e),(0,b.Xo)("fecha","desc"));A((await (0,b.PL)(s)).docs.map(e=>({id:e.id,...e.data()}))),N(a.find(a=>a.id===e)||null),I(!0)};return(0,t.jsxs)(l.Zb,{children:[(0,t.jsxs)(l.Ol,{className:"flex-row justify-between items-center",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(l.ll,{children:"Cat\xe1logo de \xcdtems"}),(0,t.jsx)(l.SZ,{children:"Administra las partidas y precios base para tus itemizados."})]}),(0,t.jsxs)(n.z,{onClick:()=>E(),children:[(0,t.jsx)(p.Z,{className:"mr-2"})," Nuevo \xcdtem"]})]}),(0,t.jsx)(l.aY,{children:(0,t.jsxs)(d.iA,{children:[(0,t.jsx)(d.xD,{children:(0,t.jsxs)(d.SC,{children:[(0,t.jsx)(d.ss,{children:"C\xf3digo"}),(0,t.jsx)(d.ss,{children:"Descripci\xf3n"}),(0,t.jsx)(d.ss,{children:"Unidad"}),(0,t.jsx)(d.ss,{children:"Precio Actual"}),(0,t.jsx)(d.ss,{children:"Acciones"})]})}),(0,t.jsx)(d.RM,{children:r?(0,t.jsx)(d.SC,{children:(0,t.jsx)(d.pj,{colSpan:5,className:"text-center",children:"Cargando..."})}):a.map(e=>(0,t.jsxs)(d.SC,{children:[(0,t.jsx)(d.pj,{className:"font-mono",children:e.codigo}),(0,t.jsx)(d.pj,{children:e.descripcion}),(0,t.jsx)(d.pj,{children:e.unidad}),(0,t.jsx)(d.pj,{children:S(e.precioActual)}),(0,t.jsxs)(d.pj,{className:"flex gap-2",children:[(0,t.jsx)(n.z,{variant:"ghost",size:"icon",onClick:()=>E(e),children:(0,t.jsx)(j.Z,{className:"h-4 w-4"})}),(0,t.jsx)(n.z,{variant:"ghost",size:"icon",onClick:()=>P(e.id),children:(0,t.jsx)(f.Z,{className:"h-4 w-4"})})]})]},e.id))})]})}),(0,t.jsx)(x.Vq,{open:m,onOpenChange:h,children:(0,t.jsx)(x.cZ,{children:(0,t.jsxs)("form",{onSubmit:D,children:[(0,t.jsx)(x.fK,{children:(0,t.jsx)(x.$N,{children:(null==g?void 0:g.id)?"Editar \xcdtem":"Nuevo \xcdtem"})}),(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u._,{children:"C\xf3digo*"}),(0,t.jsx)(o.I,{value:(null==g?void 0:g.codigo)||"",onChange:e=>N(a=>({...a,codigo:e.target.value}))})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u._,{children:"Descripci\xf3n*"}),(0,t.jsx)(o.I,{value:(null==g?void 0:g.descripcion)||"",onChange:e=>N(a=>({...a,descripcion:e.target.value}))})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u._,{children:"Unidad"}),(0,t.jsx)(o.I,{value:(null==g?void 0:g.unidad)||"",onChange:e=>N(a=>({...a,unidad:e.target.value}))})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u._,{children:"Precio Actual*"}),(0,t.jsx)(o.I,{type:"number",value:(null==g?void 0:g.precioActual)||0,onChange:e=>N(a=>({...a,precioActual:Number(e.target.value)}))})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(u._,{children:"Categor\xeda"}),(0,t.jsx)(o.I,{value:(null==g?void 0:g.categoria)||"",onChange:e=>N(a=>({...a,categoria:e.target.value}))})]})]}),(0,t.jsxs)(x.cN,{children:[(0,t.jsx)(n.z,{type:"button",variant:"ghost",onClick:()=>h(!1),children:"Cancelar"}),(0,t.jsx)(n.z,{type:"submit",disabled:v,children:v?"Guardando...":"Guardar"})]})]})})}),(0,t.jsx)(x.Vq,{open:w,onOpenChange:I,children:(0,t.jsxs)(x.cZ,{children:[(0,t.jsx)(x.fK,{children:(0,t.jsxs)(x.$N,{children:["Historial de Precios: ",null==g?void 0:g.descripcion]})}),(0,t.jsxs)(d.iA,{children:[(0,t.jsx)(d.xD,{children:(0,t.jsxs)(d.SC,{children:[(0,t.jsx)(d.ss,{children:"Fecha"}),(0,t.jsx)(d.ss,{children:"Precio"}),(0,t.jsx)(d.ss,{children:"Fuente"})]})}),(0,t.jsx)(d.RM,{children:k.map(e=>{var a;return(0,t.jsxs)(d.SC,{children:[(0,t.jsx)(d.pj,{children:null===(a=e.fecha)||void 0===a?void 0:a.toDate().toLocaleDateString("es-CL")}),(0,t.jsx)(d.pj,{children:S(e.precio)}),(0,t.jsx)(d.pj,{children:e.fuente})]},e.id)})})]})]})})]})}function k(){let e=(0,r.useRouter)(),{toast:a}=(0,z.pm)(),{companyId:s,role:c}=(0,w.a)(),[o,x]=(0,i.useState)([]),[j,f]=(0,i.useState)(""),[y,I]=(0,i.useState)([]),[k,A]=(0,i.useState)(!0);(0,i.useEffect)(()=>{(s||"superadmin"===c)&&(async()=>{let e;let a=(0,b.hJ)(C.N$,"obras");e="superadmin"===c?(0,b.IO)(a,(0,b.Xo)("nombreFaena")):(0,b.IO)(a,(0,b.ar)("empresaId","==",s),(0,b.Xo)("nombreFaena"));let t=(await (0,b.PL)(e)).docs.map(e=>({id:e.id,nombreFaena:e.data().nombreFaena}));x(t),t.length>0&&f(t[0].id)})()},[s,c]),(0,i.useEffect)(()=>{if(!j){I([]),A(!1);return}A(!0);let e=(0,b.IO)((0,b.hJ)(C.N$,"presupuestos"),(0,b.ar)("obraId","==",j),(0,b.Xo)("fechaCreacion","desc")),s=(0,b.cf)(e,e=>{I(e.docs.map(e=>({id:e.id,...e.data()}))),A(!1)},e=>{console.error("Error fetching presupuestos:",e),a({variant:"destructive",title:"Error",description:"No se pudieron cargar los itemizados."}),A(!1)});return()=>s()},[j,a]);let E=async e=>{try{await (0,b.oe)((0,b.JU)(C.N$,"presupuestos",e)),I(a=>a.filter(a=>a.id!==e)),a({title:"\xc9xito",description:"Itemizado eliminado correctamente."})}catch(e){console.error("Error deleting budget:",e),a({variant:"destructive",title:"Error",description:"No se pudo eliminar el itemizado."})}};return(0,t.jsxs)(l.Zb,{children:[(0,t.jsxs)(l.Ol,{className:"flex-row justify-between items-center",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(l.ll,{children:"Itemizados por Obra"}),(0,t.jsx)(l.SZ,{children:"Crea, edita y gestiona itemizados para cada obra."})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(n.z,{variant:"outline",onClick:()=>e.push("/operaciones/presupuestos/itemizados/importar"),children:[(0,t.jsx)(g.Z,{className:"mr-2 h-4 w-4"})," Importar (beta)"]}),(0,t.jsxs)(n.z,{onClick:()=>e.push("/operaciones/presupuestos/nuevo?obraId=".concat(j)),disabled:!j,children:[(0,t.jsx)(p.Z,{className:"mr-2"})," Nuevo Itemizado"]})]})]}),(0,t.jsxs)(l.aY,{children:[(0,t.jsxs)("div",{className:"max-w-md mb-4",children:[(0,t.jsx)(u._,{children:"Seleccione una obra"}),(0,t.jsxs)(m.Ph,{value:j,onValueChange:f,children:[(0,t.jsx)(m.i4,{children:(0,t.jsx)(m.ki,{placeholder:"Seleccionar obra..."})}),(0,t.jsx)(m.Bw,{children:o.map(e=>(0,t.jsx)(m.Ql,{value:e.id,children:e.nombreFaena},e.id))})]})]}),(0,t.jsxs)(d.iA,{children:[(0,t.jsx)(d.xD,{children:(0,t.jsxs)(d.SC,{children:[(0,t.jsx)(d.ss,{children:"Nombre"}),(0,t.jsx)(d.ss,{children:"Fecha"}),(0,t.jsx)(d.ss,{children:"Total"}),(0,t.jsx)(d.ss,{children:"Acciones"})]})}),(0,t.jsx)(d.RM,{children:k?(0,t.jsx)(d.SC,{children:(0,t.jsx)(d.pj,{colSpan:4,className:"text-center",children:"Cargando..."})}):y.map(a=>{var s;return(0,t.jsxs)(d.SC,{children:[(0,t.jsx)(d.pj,{children:a.nombre}),(0,t.jsx)(d.pj,{children:null===(s=a.fechaCreacion)||void 0===s?void 0:s.toDate().toLocaleDateString("es-CL")}),(0,t.jsx)(d.pj,{children:S(a.totalPresupuesto||0)}),(0,t.jsxs)(d.pj,{className:"flex gap-2",children:[(0,t.jsxs)(n.z,{variant:"secondary",size:"sm",onClick:()=>e.push("/operaciones/programacion?obraId=".concat(a.obraId)),children:[(0,t.jsx)(N.Z,{className:"mr-2 h-3 w-3"}),"Ir a Programaci\xf3n"]}),(0,t.jsx)(n.z,{variant:"outline",size:"sm",onClick:()=>e.push("/operaciones/presupuestos/".concat(a.id)),children:"Ver / Editar"}),(0,t.jsxs)(h.aR,{children:[(0,t.jsx)(h.vW,{asChild:!0,children:(0,t.jsx)(n.z,{variant:"ghost",size:"icon",className:"text-destructive hover:text-destructive",children:(0,t.jsx)(v.Z,{className:"h-4 w-4"})})}),(0,t.jsxs)(h._T,{children:[(0,t.jsxs)(h.fY,{children:[(0,t.jsx)(h.f$,{children:"\xbfEliminar Itemizado?"}),(0,t.jsx)(h.yT,{children:"Esta acci\xf3n no se puede deshacer."})]}),(0,t.jsxs)(h.xo,{children:[(0,t.jsx)(h.le,{children:"Cancelar"}),(0,t.jsx)(h.OL,{onClick:()=>E(a.id),children:"Eliminar"})]})]})]})]})]},a.id)})})]})]})]})}function A(){let e=(0,r.useRouter)();return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("header",{className:"flex items-center gap-4",children:[(0,t.jsx)(n.z,{variant:"outline",size:"icon",onClick:()=>e.push("/dashboard"),children:(0,t.jsx)(y.Z,{})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold",children:"Itemizados"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Administra tu cat\xe1logo de \xedtems y crea itemizados por obra."})]})]}),(0,t.jsxs)(c.mQ,{defaultValue:"presupuestos",className:"w-full",children:[(0,t.jsxs)(c.dr,{children:[(0,t.jsx)(c.SP,{value:"presupuestos",children:"Itemizados por Obra"}),(0,t.jsx)(c.SP,{value:"catalogo",children:"Cat\xe1logo de \xcdtems"})]}),(0,t.jsx)(c.nU,{value:"presupuestos",children:(0,t.jsx)(k,{})}),(0,t.jsx)(c.nU,{value:"catalogo",children:(0,t.jsx)(I,{})})]})]})}},30767:function(e,a,s){"use strict";s.d(a,{OL:function(){return f},_T:function(){return x},aR:function(){return c},f$:function(){return p},fY:function(){return m},le:function(){return g},vW:function(){return d},xo:function(){return h},yT:function(){return j}});var t=s(57437),i=s(2265),r=s(7880),n=s(93448),l=s(12381);let c=r.fC,d=r.xz,o=r.h_,u=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.aV,{className:(0,n.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...i,ref:a})});u.displayName=r.aV.displayName;let x=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsxs)(o,{children:[(0,t.jsx)(u,{}),(0,t.jsx)(r.VY,{ref:a,className:(0,n.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...i})]})});x.displayName=r.VY.displayName;let m=e=>{let{className:a,...s}=e;return(0,t.jsx)("div",{className:(0,n.cn)("flex flex-col space-y-2 text-center sm:text-left",a),...s})};m.displayName="AlertDialogHeader";let h=e=>{let{className:a,...s}=e;return(0,t.jsx)("div",{className:(0,n.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...s})};h.displayName="AlertDialogFooter";let p=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.Dx,{ref:a,className:(0,n.cn)("text-lg font-semibold",s),...i})});p.displayName=r.Dx.displayName;let j=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.dk,{ref:a,className:(0,n.cn)("text-sm text-muted-foreground",s),...i})});j.displayName=r.dk.displayName;let f=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.aU,{ref:a,className:(0,n.cn)((0,l.d)(),s),...i})});f.displayName=r.aU.displayName;let g=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.$j,{ref:a,className:(0,n.cn)((0,l.d)({variant:"outline"}),"mt-2 sm:mt-0",s),...i})});g.displayName=r.$j.displayName},74291:function(e,a,s){"use strict";s.d(a,{$N:function(){return p},Be:function(){return j},Vq:function(){return c},cN:function(){return h},cZ:function(){return x},fK:function(){return m},hg:function(){return d}});var t=s(57437),i=s(2265),r=s(70001),n=s(44986),l=s(93448);let c=r.fC,d=r.xz,o=r.h_;r.x8;let u=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.aV,{ref:a,className:(0,l.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...i})});u.displayName=r.aV.displayName;let x=i.forwardRef((e,a)=>{let{className:s,children:i,...c}=e;return(0,t.jsxs)(o,{children:[(0,t.jsx)(u,{}),(0,t.jsxs)(r.VY,{ref:a,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...c,children:[i,(0,t.jsxs)(r.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,t.jsx)(n.Z,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});x.displayName=r.VY.displayName;let m=e=>{let{className:a,...s}=e;return(0,t.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",a),...s})};m.displayName="DialogHeader";let h=e=>{let{className:a,...s}=e;return(0,t.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...s})};h.displayName="DialogFooter";let p=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.Dx,{ref:a,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight",s),...i})});p.displayName=r.Dx.displayName;let j=i.forwardRef((e,a)=>{let{className:s,...i}=e;return(0,t.jsx)(r.dk,{ref:a,className:(0,l.cn)("text-sm text-muted-foreground",s),...i})});j.displayName=r.dk.displayName}},function(e){e.O(0,[4358,9990,6137,1211,9759,3562,6008,9923,2550,1,1660,2584,2971,2117,1744],function(){return e(e.s=71998)}),_N_E=e.O()}]);