(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8787,2087],{11134:function(e,t,a){Promise.resolve().then(a.bind(a,85221))},85221:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return P}});var r=a(57437),s=a(2265),n=a(71245),o=a(99376),l=a(5978),i=a(99764),d=a(73367),c=a(79820),u=a(75060),f=a(15291),m=a(33804),x=a(12381),p=a(5485),h=a(54585),g=a(42050),j=a(16275),b=a(94438),N=a(87928),v=a(43728),y=a(53459),w=a(74291),S=a(40279),_=a(30767),C=a(23340),E=a(53375),F=a(2578),I=a.n(F);function D(e){return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",maximumFractionDigits:0}).format(e)}function R(e){return e.toLocaleString("es-CL",{style:"currency",currency:"CLP",maximumFractionDigits:0})}function T(){let{user:e,companyId:t,role:a,loading:F}=(0,n.a)(),T=(0,o.useRouter)(),P=(0,o.useSearchParams)(),{toast:A}=(0,C.pm)(),[O,k]=(0,s.useState)([]),[z,Z]=(0,s.useState)(null),[M,G]=(0,s.useState)(""),[$,L]=(0,s.useState)([]),[V,Y]=(0,s.useState)([]),{avancesPorActividad:U}=(0,d.n)(M,$),[B,X]=(0,s.useState)(!0),[J,H]=(0,s.useState)(!0),[q,W]=(0,s.useState)(!1),[Q,K]=(0,s.useState)(null),[ee,et]=(0,s.useState)(!1),[ea,er]=(0,s.useState)(new Date().toISOString().slice(0,10));(0,s.useEffect)(()=>{F||e||T.replace("/login/usuario")},[F,e,T]),(0,s.useEffect)(()=>{async function r(){try{let e;K(null);let r=(0,l.hJ)(i.N$,"obras");e="superadmin"===a?(0,l.IO)(r,(0,l.Xo)("nombreFaena")):(0,l.IO)(r,(0,l.ar)("empresaId","==",t),(0,l.Xo)("nombreFaena"));let s=(await (0,l.PL)(e)).docs.map(e=>({id:e.id,...e.data()}));k(s);let n=P.get("obraId");n&&s.some(e=>e.id===n)?G(n):s.length>0&&G(s[0].id)}catch(e){console.error(e),K("No se pudieron cargar las obras.")}}async function s(){if(t)try{let e=(0,l.JU)(i.N$,"companies",t),a=await (0,l.QT)(e);a.exists()&&Z(a.data())}catch(e){console.error("Error al cargar datos de la empresa:",e)}}e&&(t||"superadmin"===a)&&(r(),s())},[e,P,t,a]),(0,s.useEffect)(()=>{if(!M||!e){L([]),Y([]);return}X(!0);let t=(0,l.hJ)(i.N$,"obras",M,"actividades"),a=(0,l.IO)(t,(0,l.Xo)("fechaInicio","asc")),r=(0,l.cf)(a,e=>{L(e.docs.map(e=>({...e.data(),id:e.id}))),X(!1)},e=>{console.error("Error cargando actividades:",e),K("No se pudieron cargar las actividades de la obra."),X(!1)});H(!0);let s=(0,l.hJ)(i.N$,"obras",M,"estadosDePago"),n=(0,l.IO)(s,(0,l.Xo)("correlativo","desc")),o=(0,l.cf)(n,e=>{Y(e.docs.map(e=>({...e.data(),id:e.id}))),H(!1)},e=>{console.error("Error cargando estados de pago:",e),K("No se pudo cargar el historial de estados de pago."),H(!1)});return()=>{r(),o()}},[M,e]);let es=(0,s.useMemo)(()=>{let e=$.reduce((e,t)=>e+(t.cantidad||0)*(t.precioContrato||0),0),t=$.reduce((e,t)=>{var a,r;return e+(null!==(r=null===(a=U[t.id])||void 0===a?void 0:a.porcentajeAcumulado)&&void 0!==r?r:0)/100*((t.cantidad||0)*(t.precioContrato||0))},0);return{montoTotalContrato:e,avanceRealGlobal:Math.min(100,e>0?t/e*100:0),montoEjecutado:t,saldoPorFacturar:t}},[$,U]),en=async()=>{if(M){W(!0),K(null);try{let e=V.reduce((e,t)=>Math.max(e,t.correlativo),0)+1,t=$.map(e=>{var t;let a=U[e.id],r=null!==(t=null==a?void 0:a.porcentajeAcumulado)&&void 0!==t?t:0,s=(e.cantidad||0)*e.precioContrato*(r/100);return{actividadId:e.id,nombre:e.nombreActividad,precioContrato:e.precioContrato,cantidad:e.cantidad,unidad:e.unidad,porcentajeAvance:r,montoProyectado:s}}),a=t.reduce((e,t)=>e+t.montoProyectado,0),r=.19*a,s=(0,l.hJ)(i.N$,"obras",M,"estadosDePago"),n={obraId:M,correlativo:e,fechaGeneracion:new Date().toISOString().slice(0,10),fechaDeCorte:ea,subtotal:a,iva:r,total:a+r,actividades:t,creadoEn:(0,l.Bt)()};await (0,l.ET)(s,n),et(!1),A({title:"Estado de Pago Generado",description:"Se ha creado el EDP-".concat(e.toString().padStart(3,"0"),".")})}catch(e){console.error("Error generando estado de pago:",e),K("No se pudo generar el estado de pago. Int\xe9ntelo de nuevo."),A({variant:"destructive",title:"Error",description:"No se pudo generar el estado de pago."})}finally{W(!1)}}},eo=async e=>{if(M)try{let t=(0,l.JU)(i.N$,"obras",M,"estadosDePago",e);await (0,l.oe)(t),A({title:"Estado de Pago Eliminado",description:"El registro ha sido eliminado correctamente."})}catch(e){console.error("Error eliminando estado de pago:",e),K("No se pudo eliminar el estado de pago."),A({variant:"destructive",title:"Error",description:"No se pudo eliminar el estado de pago."})}},el=e=>{let t=O.find(t=>t.id===e.obraId);if(!t){A({variant:"destructive",title:"Error",description:"No se encontraron los datos de la obra para generar el PDF."});return}if(!z){A({variant:"destructive",title:"Error",description:"No se encontraron los datos de la empresa para generar el PDF."});return}!function(e,t,a){let r=new E.default("p","mm","a4"),s=20;r.setFont("helvetica","bold"),r.setFontSize(16),r.text("PCG \xb7 Plataforma de Control y Gesti\xf3n",15,s),s+=8,r.setFontSize(12),r.text("Estado de Pago: ".concat(t.nombreFaena),15,s),s+=6,r.setFont("helvetica","normal"),r.text("EDP N\xb0: ".concat(a.correlativo.toString().padStart(3,"0")),15,s),s+=5,r.text("Fecha de Corte: ".concat(new Date(a.fechaDeCorte+"T00:00:00").toLocaleDateString("es-CL")),15,s),s+=10,r.setFont("helvetica","bold"),r.text("Constructora:",15,s),r.setFont("helvetica","normal"),r.text(e.nombreFantasia||e.razonSocial,50,s),s+=5,r.setFont("helvetica","bold"),r.text("Mandante:",15,s),r.setFont("helvetica","normal"),r.text(t.mandante||"No especificado",50,s),s+=5,r.setFont("helvetica","bold"),r.text("Cliente:",15,s),r.setFont("helvetica","normal"),r.text(t.clienteEmail||"No especificado",50,s),s+=10;let n=a.actividades.map((e,t)=>[t+1,e.nombre,e.cantidad.toLocaleString("es-CL"),e.unidad,D(e.precioContrato),"".concat(e.porcentajeAvance.toFixed(1),"%"),D(e.montoProyectado)]);I()(r,{startY:s,head:[["\xcdtem","Descripci\xf3n","Cant.","Un.","P. Unitario","% Avance","Monto a cobrar"]],body:n,theme:"grid",headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},columnStyles:{6:{halign:"right"},4:{halign:"right"},5:{halign:"right"}}}),s=r.lastAutoTable.finalY+10,r.setFont("helvetica","normal"),r.setFontSize(10),r.text("Subtotal Neto:",150,s,{align:"right"}),r.text(D(a.subtotal),195,s,{align:"right"}),s+=6,r.text("IVA (19%):",150,s,{align:"right"}),r.text(D(a.iva),195,s,{align:"right"}),s+=6,r.setFont("helvetica","bold"),r.setFontSize(12),r.text("Total a Pagar:",150,s,{align:"right"}),r.text(D(a.total),195,s,{align:"right"}),s+=25,r.text("________________________",15,s),r.text("________________________",110,s),s+=5,r.setFontSize(9),r.text("Firma Contratista",15,s),r.text("Firma Mandante / ITO",110,s),function(e){let t=e.internal.getNumberOfPages();for(let a=1;a<=t;a++){e.setPage(a);let r=e.internal.pageSize.getHeight();e.setFontSize(8),e.setTextColor(120),e.text("Documento generado con PCG \xb7 Plataforma de Control y Gesti\xf3n",105,r-15,{align:"center"}),e.text("P\xe1gina ".concat(a," de ").concat(t),105,r-8,{align:"center"}),e.setTextColor(0)}}(r),r.save("EDP-".concat(a.correlativo.toString().padStart(3,"0"),"-").concat(t.nombreFaena.replace(/ /g,"_"),".pdf"))}(z,t,e)};return F?(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Cargando sesi\xf3n..."}):(0,r.jsxs)("div",{className:"space-y-8",children:[(0,r.jsxs)("header",{className:"flex items-center gap-4",children:[(0,r.jsx)(x.z,{variant:"outline",size:"icon",onClick:()=>T.push("/dashboard"),children:(0,r.jsx)(p.Z,{className:"h-4 w-4"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-4xl font-bold font-headline tracking-tight",children:"Estados de Pago"}),(0,r.jsx)("p",{className:"mt-2 text-lg text-muted-foreground",children:"Gestiona y visualiza el avance econ\xf3mico de tus obras en base a los contratos y avances registrados."})]})]}),Q&&(0,r.jsx)("p",{className:"text-sm font-medium text-destructive",children:Q}),(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{children:[(0,r.jsx)(c.ll,{children:"Selector de Obra"}),(0,r.jsx)(c.SZ,{children:"Filtre para ver el estado de pago de una obra espec\xedfica."})]}),(0,r.jsx)(c.aY,{children:(0,r.jsxs)("div",{className:"max-w-xs space-y-2",children:[(0,r.jsx)(u._,{htmlFor:"obra-select",children:"Seleccione una obra"}),(0,r.jsxs)(f.Ph,{value:M,onValueChange:G,children:[(0,r.jsx)(f.i4,{id:"obra-select",children:(0,r.jsx)(f.ki,{placeholder:"Seleccione una obra"})}),(0,r.jsx)(f.Bw,{children:O.map(e=>(0,r.jsx)(f.Ql,{value:e.id,children:e.nombreFaena},e.id))})]})]})})]}),M&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("section",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(c.ll,{className:"text-sm font-medium",children:"Monto Total Contrato"}),(0,r.jsx)(h.Z,{className:"h-4 w-4 text-muted-foreground"})]}),(0,r.jsxs)(c.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold",children:R(es.montoTotalContrato)}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Valor total de las actividades programadas."})]})]}),(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(c.ll,{className:"text-sm font-medium",children:"Avance F\xedsico Global"}),(0,r.jsx)(g.Z,{className:"h-4 w-4 text-muted-foreground"})]}),(0,r.jsxs)(c.aY,{children:[(0,r.jsxs)("div",{className:"text-2xl font-bold",children:[es.avanceRealGlobal.toFixed(1),"%"]}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Basado en el costo real ejecutado vs el total."})]})]}),(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(c.ll,{className:"text-sm font-medium",children:"Monto Ejecutado a la Fecha"}),(0,r.jsx)(j.Z,{className:"h-4 w-4 text-muted-foreground"})]}),(0,r.jsxs)(c.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold",children:R(es.montoEjecutado)}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Valor del trabajo completado hasta hoy."})]})]}),(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(c.ll,{className:"text-sm font-medium",children:"Saldo por Facturar (Ref.)"}),(0,r.jsx)(h.Z,{className:"h-4 w-4 text-muted-foreground"})]}),(0,r.jsxs)(c.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold",children:R(es.saldoPorFacturar)}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Monto ejecutado pendiente de pago."})]})]})]}),(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(c.ll,{children:"Estados de Pago Generados"}),(0,r.jsx)(c.SZ,{children:"Historial de los estados de pago generados para la obra seleccionada."})]}),(0,r.jsxs)(x.z,{onClick:()=>et(!0),className:"mt-4 sm:mt-0",children:[(0,r.jsx)(b.Z,{className:"mr-2 h-4 w-4"}),"Generar Nuevo Estado de Pago"]})]}),(0,r.jsx)(c.aY,{children:J?(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Cargando historial..."}):0===V.length?(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"No se han generado estados de pago para esta obra."}):(0,r.jsx)("div",{className:"border rounded-md",children:(0,r.jsxs)(m.iA,{children:[(0,r.jsx)(m.xD,{children:(0,r.jsxs)(m.SC,{children:[(0,r.jsx)(m.ss,{children:"Correlativo"}),(0,r.jsx)(m.ss,{children:"Fecha Generaci\xf3n"}),(0,r.jsx)(m.ss,{children:"Fecha Corte"}),(0,r.jsx)(m.ss,{className:"text-right",children:"Total"}),(0,r.jsx)(m.ss,{className:"text-right",children:"Acciones"})]})}),(0,r.jsx)(m.RM,{children:V.map(e=>(0,r.jsxs)(m.SC,{children:[(0,r.jsxs)(m.pj,{className:"font-medium",children:["EDP-",e.correlativo.toString().padStart(3,"0")]}),(0,r.jsx)(m.pj,{children:new Date(e.fechaGeneracion+"T00:00:00").toLocaleDateString("es-CL")}),(0,r.jsx)(m.pj,{children:new Date(e.fechaDeCorte+"T00:00:00").toLocaleDateString("es-CL")}),(0,r.jsx)(m.pj,{className:"text-right",children:R(e.total)}),(0,r.jsx)(m.pj,{className:"text-right",children:(0,r.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,r.jsxs)(x.z,{onClick:()=>el(e),variant:"outline",size:"sm",children:[(0,r.jsx)(N.Z,{className:"mr-2 h-3 w-3"}),"Ver PDF"]}),(0,r.jsxs)(_.aR,{children:[(0,r.jsx)(_.vW,{asChild:!0,children:(0,r.jsxs)(x.z,{variant:"ghost",size:"icon",className:"text-destructive hover:text-destructive h-9 w-9",children:[(0,r.jsx)(v.Z,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"sr-only",children:"Eliminar"})]})}),(0,r.jsxs)(_._T,{children:[(0,r.jsxs)(_.fY,{children:[(0,r.jsx)(_.f$,{children:"\xbfEst\xe1 seguro de que desea eliminar este estado de pago?"}),(0,r.jsxs)(_.yT,{children:["Esta acci\xf3n no se puede deshacer. Se eliminar\xe1 el registro EDP-",e.correlativo.toString().padStart(3,"0"),"."]})]}),(0,r.jsxs)(_.xo,{children:[(0,r.jsx)(_.le,{children:"Cancelar"}),(0,r.jsx)(_.OL,{onClick:()=>eo(e.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Eliminar"})]})]})]})]})})]},e.id))})]})})})]}),(0,r.jsx)(w.Vq,{open:ee,onOpenChange:et,children:(0,r.jsxs)(w.cZ,{className:"sm:max-w-[425px]",children:[(0,r.jsxs)(w.fK,{children:[(0,r.jsx)(w.$N,{children:"Generar Estado de Pago"}),(0,r.jsx)(w.Be,{children:"Seleccione la fecha de corte para calcular el avance y generar el informe. El sistema considerar\xe1 todos los avances registrados hasta esta fecha."})]}),(0,r.jsx)("div",{className:"grid gap-4 py-4",children:(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(u._,{htmlFor:"fecha-corte-edp",children:"Fecha de corte del informe"}),(0,r.jsx)(S.I,{id:"fecha-corte-edp",type:"date",value:ea,onChange:e=>er(e.target.value)})]})}),(0,r.jsx)(w.cN,{children:(0,r.jsxs)(x.z,{onClick:en,disabled:q,children:[q&&(0,r.jsx)(y.Z,{className:"animate-spin mr-2"}),q?"Generando...":"Confirmar y Generar"]})})]})}),(0,r.jsxs)(c.Zb,{children:[(0,r.jsxs)(c.Ol,{children:[(0,r.jsx)(c.ll,{children:"Borrador de Estado de Pago"}),(0,r.jsx)(c.SZ,{children:"Esta es una vista previa del estado de pago basada en el avance real registrado hasta la fecha de hoy."})]}),(0,r.jsx)(c.aY,{children:(0,r.jsx)("div",{className:"overflow-x-auto border rounded-lg",children:(0,r.jsxs)(m.iA,{children:[(0,r.jsx)(m.xD,{children:(0,r.jsxs)(m.SC,{children:[(0,r.jsx)(m.ss,{className:"w-[30%]",children:"Actividad"}),(0,r.jsx)(m.ss,{children:"Un."}),(0,r.jsx)(m.ss,{children:"Cant."}),(0,r.jsx)(m.ss,{children:"P. Unitario"}),(0,r.jsx)(m.ss,{children:"Total Partida"}),(0,r.jsx)(m.ss,{children:"Avance Real (%)"}),(0,r.jsx)(m.ss,{className:"text-right",children:"Monto Ejecutado"})]})}),(0,r.jsx)(m.RM,{children:B?(0,r.jsx)(m.SC,{children:(0,r.jsx)(m.pj,{colSpan:7,className:"text-center h-24",children:"Cargando actividades..."})}):0===$.length?(0,r.jsx)(m.SC,{children:(0,r.jsx)(m.pj,{colSpan:7,className:"text-center h-24",children:"No hay actividades programadas para esta obra."})}):$.map(e=>{let t=(e.cantidad||0)*(e.precioContrato||0),a=U[e.id]||{porcentajeAcumulado:0},s=a.porcentajeAcumulado/100*t;return(0,r.jsxs)(m.SC,{children:[(0,r.jsx)(m.pj,{className:"font-medium",children:e.nombreActividad}),(0,r.jsx)(m.pj,{children:e.unidad||"-"}),(0,r.jsx)(m.pj,{children:e.cantidad||"-"}),(0,r.jsx)(m.pj,{children:R(e.precioContrato)}),(0,r.jsx)(m.pj,{className:"font-semibold",children:R(t)}),(0,r.jsxs)(m.pj,{className:"font-semibold text-blue-600",children:[a.porcentajeAcumulado.toFixed(1),"%"]}),(0,r.jsx)(m.pj,{className:"text-right font-bold",children:R(s)})]},e.id)})})]})})})]})]})]})}function P(){return(0,r.jsx)(s.Suspense,{fallback:(0,r.jsx)("div",{children:"Cargando..."}),children:(0,r.jsx)(T,{})})}},73367:function(e,t,a){"use strict";a.d(t,{n:function(){return o}});var r=a(2265),s=a(5978),n=a(99764);function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],[a,o]=(0,r.useState)([]),[l,i]=(0,r.useState)(!0),[d,c]=(0,r.useState)(null),u=(0,r.useCallback)(()=>{if(!e){o([]),i(!1);return}i(!0);let t=(0,s.hJ)(n.N$,"obras",e,"avancesDiarios"),a=(0,s.IO)(t,(0,s.Xo)("fecha","desc"));return(0,s.cf)(a,e=>{o(e.docs.map(e=>({id:e.id,...e.data()}))),i(!1)},e=>{console.error("Error fetching avances: ",e),c("No se pudieron cargar los avances."),i(!1)})},[e]);(0,r.useEffect)(()=>{let e=u();return()=>null==e?void 0:e()},[u]);let f=(0,r.useMemo)(()=>{let e={};if(!t)return e;let r=a.filter(e=>"FOTOGRAFICO"!==e.tipoRegistro&&"number"==typeof e.cantidadEjecutada),s={};for(let e of r)e.actividadId&&(s[e.actividadId]||(s[e.actividadId]=0),s[e.actividadId]+=Number(e.cantidadEjecutada||0));for(let a of t){let t=s[a.id]||0,r=a.cantidad>0?t/a.cantidad*100:0;e[a.id]={cantidadAcumulada:t,porcentajeAcumulado:Math.min(100,r)}}return e},[a,t]);return{avances:a,avancesPorActividad:f,loading:l,error:d,refetchAvances:u}}},30767:function(e,t,a){"use strict";a.d(t,{OL:function(){return g},_T:function(){return f},aR:function(){return i},f$:function(){return p},fY:function(){return m},le:function(){return j},vW:function(){return d},xo:function(){return x},yT:function(){return h}});var r=a(57437),s=a(2265),n=a(7880),o=a(93448),l=a(12381);let i=n.fC,d=n.xz,c=n.h_,u=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.aV,{className:(0,o.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...s,ref:t})});u.displayName=n.aV.displayName;let f=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsxs)(c,{children:[(0,r.jsx)(u,{}),(0,r.jsx)(n.VY,{ref:t,className:(0,o.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...s})]})});f.displayName=n.VY.displayName;let m=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:(0,o.cn)("flex flex-col space-y-2 text-center sm:text-left",t),...a})};m.displayName="AlertDialogHeader";let x=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:(0,o.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...a})};x.displayName="AlertDialogFooter";let p=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.Dx,{ref:t,className:(0,o.cn)("text-lg font-semibold",a),...s})});p.displayName=n.Dx.displayName;let h=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.dk,{ref:t,className:(0,o.cn)("text-sm text-muted-foreground",a),...s})});h.displayName=n.dk.displayName;let g=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.aU,{ref:t,className:(0,o.cn)((0,l.d)(),a),...s})});g.displayName=n.aU.displayName;let j=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.$j,{ref:t,className:(0,o.cn)((0,l.d)({variant:"outline"}),"mt-2 sm:mt-0",a),...s})});j.displayName=n.$j.displayName},12381:function(e,t,a){"use strict";a.d(t,{d:function(){return i},z:function(){return d}});var r=a(57437),s=a(2265),n=a(37053),o=a(90535),l=a(93448);let i=(0,o.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),d=s.forwardRef((e,t)=>{let{className:a,variant:s,size:o,asChild:d=!1,...c}=e,u=d?n.g7:"button";return(0,r.jsx)(u,{className:(0,l.cn)(i({variant:s,size:o,className:a})),ref:t,...c})});d.displayName="Button"},79820:function(e,t,a){"use strict";a.d(t,{Ol:function(){return l},SZ:function(){return d},Zb:function(){return o},aY:function(){return c},eW:function(){return u},ll:function(){return i}});var r=a(57437),s=a(2265),n=a(93448);let o=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",a),...s})});o.displayName="Card";let l=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("flex flex-col space-y-1.5 p-6",a),...s})});l.displayName="CardHeader";let i=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("text-2xl font-semibold leading-none tracking-tight",a),...s})});i.displayName="CardTitle";let d=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("text-sm text-muted-foreground",a),...s})});d.displayName="CardDescription";let c=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("p-6 pt-0",a),...s})});c.displayName="CardContent";let u=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("flex items-center p-6 pt-0",a),...s})});u.displayName="CardFooter"},74291:function(e,t,a){"use strict";a.d(t,{$N:function(){return p},Be:function(){return h},Vq:function(){return i},cN:function(){return x},cZ:function(){return f},fK:function(){return m},hg:function(){return d}});var r=a(57437),s=a(2265),n=a(70001),o=a(44986),l=a(93448);let i=n.fC,d=n.xz,c=n.h_;n.x8;let u=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.aV,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...s})});u.displayName=n.aV.displayName;let f=s.forwardRef((e,t)=>{let{className:a,children:s,...i}=e;return(0,r.jsxs)(c,{children:[(0,r.jsx)(u,{}),(0,r.jsxs)(n.VY,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...i,children:[s,(0,r.jsxs)(n.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,r.jsx)(o.Z,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});f.displayName=n.VY.displayName;let m=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...a})};m.displayName="DialogHeader";let x=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...a})};x.displayName="DialogFooter";let p=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.Dx,{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight",a),...s})});p.displayName=n.Dx.displayName;let h=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.dk,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",a),...s})});h.displayName=n.dk.displayName},40279:function(e,t,a){"use strict";a.d(t,{I:function(){return o}});var r=a(57437),s=a(2265),n=a(93448);let o=s.forwardRef((e,t)=>{let{className:a,type:s,...o}=e;return(0,r.jsx)("input",{type:s,className:(0,n.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:t,...o})});o.displayName="Input"},75060:function(e,t,a){"use strict";a.d(t,{_:function(){return d}});var r=a(57437),s=a(2265),n=a(370),o=a(90535),l=a(93448);let i=(0,o.j)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),d=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.f,{ref:t,className:(0,l.cn)(i(),a),...s})});d.displayName=n.f.displayName},15291:function(e,t,a){"use strict";a.d(t,{Bw:function(){return p},Ph:function(){return c},Ql:function(){return h},i4:function(){return f},ki:function(){return u}});var r=a(57437),s=a(2265),n=a(74797),o=a(3289),l=a(47969),i=a(59559),d=a(93448);let c=n.fC;n.ZA;let u=n.B4,f=s.forwardRef((e,t)=>{let{className:a,children:s,...l}=e;return(0,r.jsxs)(n.xz,{ref:t,className:(0,d.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...l,children:[s,(0,r.jsx)(n.JO,{asChild:!0,children:(0,r.jsx)(o.Z,{className:"h-4 w-4 opacity-50"})})]})});f.displayName=n.xz.displayName;let m=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.u_,{ref:t,className:(0,d.cn)("flex cursor-default items-center justify-center py-1",a),...s,children:(0,r.jsx)(l.Z,{className:"h-4 w-4"})})});m.displayName=n.u_.displayName;let x=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.$G,{ref:t,className:(0,d.cn)("flex cursor-default items-center justify-center py-1",a),...s,children:(0,r.jsx)(o.Z,{className:"h-4 w-4"})})});x.displayName=n.$G.displayName;let p=s.forwardRef((e,t)=>{let{className:a,children:s,position:o="popper",...l}=e;return(0,r.jsx)(n.h_,{children:(0,r.jsxs)(n.VY,{ref:t,className:(0,d.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===o&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:o,...l,children:[(0,r.jsx)(m,{}),(0,r.jsx)(n.l_,{className:(0,d.cn)("p-1","popper"===o&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),(0,r.jsx)(x,{})]})})});p.displayName=n.VY.displayName,s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.__,{ref:t,className:(0,d.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...s})}).displayName=n.__.displayName;let h=s.forwardRef((e,t)=>{let{className:a,children:s,...o}=e;return(0,r.jsxs)(n.ck,{ref:t,className:(0,d.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...o,children:[(0,r.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,r.jsx)(n.wU,{children:(0,r.jsx)(i.Z,{className:"h-4 w-4"})})}),(0,r.jsx)(n.eT,{children:s})]})});h.displayName=n.ck.displayName,s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)(n.Z0,{ref:t,className:(0,d.cn)("-mx-1 my-1 h-px bg-muted",a),...s})}).displayName=n.Z0.displayName},33804:function(e,t,a){"use strict";a.d(t,{RM:function(){return i},SC:function(){return d},iA:function(){return o},pj:function(){return u},ss:function(){return c},xD:function(){return l}});var r=a(57437),s=a(2265),n=a(93448);let o=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{className:"relative w-full overflow-auto",children:(0,r.jsx)("table",{ref:t,className:(0,n.cn)("w-full caption-bottom text-sm",a),...s})})});o.displayName="Table";let l=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("thead",{ref:t,className:(0,n.cn)("[&_tr]:border-b",a),...s})});l.displayName="TableHeader";let i=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("tbody",{ref:t,className:(0,n.cn)("[&_tr:last-child]:border-0",a),...s})});i.displayName="TableBody",s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("tfoot",{ref:t,className:(0,n.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...s})}).displayName="TableFooter";let d=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("tr",{ref:t,className:(0,n.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...s})});d.displayName="TableRow";let c=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("th",{ref:t,className:(0,n.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...s})});c.displayName="TableHead";let u=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("td",{ref:t,className:(0,n.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...s})});u.displayName="TableCell",s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("caption",{ref:t,className:(0,n.cn)("mt-4 text-sm text-muted-foreground",a),...s})}).displayName="TableCaption"},71245:function(e,t,a){"use strict";a.d(t,{H:function(){return f},a:function(){return m}});var r=a(57437),s=a(43301),n=a(2265),o=a(99764),l=a(99376),i=a(5978);async function d(e){var t;let a=o.N$,r=null===(t=e.email)||void 0===t?void 0:t.toLowerCase().trim();if(!r)return{role:"none",companyId:null};let s=(0,i.IO)((0,i.hJ)(a,"invitacionesUsuarios"),(0,i.ar)("email","==",r),(0,i.ar)("estado","==","pendiente_auth"),(0,i.b9)(1)),n=await (0,i.PL)(s);if(n.empty)return console.log("No hay invitaci\xf3n pendiente para ".concat(r,".")),{role:"none",companyId:null};let l=n.docs[0],d=l.data(),c=(0,i.JU)(a,"users",e.uid),u=(0,i.qs)(a);return u.set(c,{nombre:d.nombre||e.displayName,email:r,role:d.roleDeseado,empresaId:d.empresaId,activo:!0,createdAt:(0,i.Bt)(),updatedAt:(0,i.Bt)()},{merge:!0}),u.update(l.ref,{estado:"activado",uid:e.uid,activatedAt:(0,i.Bt)()}),await u.commit(),console.log("Usuario ".concat(r," activado con rol ").concat(d.roleDeseado," en empresa ").concat(d.empresaId,".")),{role:d.roleDeseado,companyId:d.empresaId}}async function c(e){}let u=(0,n.createContext)(void 0);function f(e){let{children:t}=e,[a,f]=(0,n.useState)(null),[m,x]=(0,n.useState)("none"),[p,h]=(0,n.useState)(null),[g,j]=(0,n.useState)(null),[b,N]=(0,n.useState)(!0),v=(0,l.useRouter)(),y=(0,l.usePathname)();async function w(e,t){try{await (0,s.e5)(o.lX,e,t)}catch(e){if("auth/invalid-credential"===e.code||"auth/wrong-password"===e.code||"auth/user-not-found"===e.code)throw Error("Credenciales inv\xe1lidas. Por favor, revisa tu correo y contrase\xf1a.");if("auth/too-many-requests"===e.code)throw Error("Demasiados intentos fallidos. Por seguridad, el acceso desde este dispositivo ha sido bloqueado temporalmente.");throw console.error("Error de login no manejado:",e),Error("Ocurri\xf3 un error inesperado al iniciar sesi\xf3n.")}}async function S(){try{await (0,s.w7)(o.lX),f(null),x("none"),h(null),j(null),v.push("/")}catch(e){console.error("Error al cerrar sesi\xf3n",e)}}return(0,n.useEffect)(()=>{let e=(0,s.Aj)(o.lX,async e=>{if(e){await c(e);let t=(0,i.JU)(o.N$,"users",e.uid),a=await (0,i.QT)(t),r="none",s=null,n=!1;if(a.exists()){let e=a.data();e.role&&void 0!==e.empresaId&&(r=e.role,s=e.empresaId,n=!0===e.mustChangePassword)}if("none"===r){let t=await d(e);r=t.role,s=t.companyId,n=!0}x(r),h(s),f(e);let l="/cambiar-password"===y;if(n&&!l)v.replace("/cambiar-password");else if(!n){if("none"===r)v.replace("/sin-acceso");else if(y.startsWith("/login")||"/"===y||l){let e="cliente"===r?"/cliente":"contratista"===r?"/cumplimiento/contratista":"/dashboard";v.replace(e)}}}else f(null),x("none"),h(null),j(null);N(!1)});return()=>e()},[v,y]),(0,n.useEffect)(()=>{if(p){let e=(0,i.JU)(o.N$,"companies",p),t=(0,s.Aj)(o.lX,t=>{t&&(0,i.QT)(e).then(e=>{e.exists()?j({id:e.id,...e.data()}):j(null)})});return()=>t()}j(null)},[p]),(0,r.jsx)(u.Provider,{value:{user:a,role:m,companyId:p,company:g,loading:b,login:w,logout:S},children:t})}function m(){let e=(0,n.useContext)(u);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}},23340:function(e,t,a){"use strict";a.d(t,{pm:function(){return f}});var r=a(2265);let s=0,n=new Map,o=e=>{if(n.has(e))return;let t=setTimeout(()=>{n.delete(e),c({type:"REMOVE_TOAST",toastId:e})},1e6);n.set(e,t)},l=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:a}=t;return a?o(a):e.toasts.forEach(e=>{o(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===a||void 0===a?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},i=[],d={toasts:[]};function c(e){d=l(d,e),i.forEach(e=>{e(d)})}function u(e){let{...t}=e,a=(s=(s+1)%Number.MAX_SAFE_INTEGER).toString(),r=()=>c({type:"DISMISS_TOAST",toastId:a});return c({type:"ADD_TOAST",toast:{...t,id:a,open:!0,onOpenChange:e=>{e||r()}}}),{id:a,dismiss:r,update:e=>c({type:"UPDATE_TOAST",toast:{...e,id:a}})}}function f(){let[e,t]=r.useState(d);return r.useEffect(()=>(i.push(t),()=>{let e=i.indexOf(t);e>-1&&i.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>c({type:"DISMISS_TOAST",toastId:e})}}},99764:function(e,t,a){"use strict";let r,s,n,o,l;a.d(t,{IG:function(){return o},N$:function(){return n},lX:function(){return s},x2:function(){return l}});var i=a(738),d=a(43301),c=a(5978),u=a(60062),f=a(13491);let m={apiKey:"AIzaSyBfMp_dH9XhFSXEeMxY-Cdy8MDRIgWrxR0",authDomain:"pcg-2-8bf1b.firebaseapp.com",projectId:"pcg-2-8bf1b",storageBucket:"pcg-2-8bf1b.appspot.com",messagingSenderId:"1073834543546",appId:"1:1073834543546:web:2f85a4a8350280f8589737"};for(let e in m)if(Object.prototype.hasOwnProperty.call(m,e)&&!m[e]){let t=e.replace(/([A-Z])/g,"_$1").toUpperCase(),a="NEXT_PUBLIC_FIREBASE_".concat(t);throw Error("Error de configuraci\xf3n del cliente: La variable de entorno Firebase '".concat(a,"' no est\xe1 definida o est\xe1 vac\xeda. ")+"Aseg\xfarate de que est\xe9 configurada en tu archivo .env.local o en las variables de entorno de producci\xf3n.")}r=(0,i.C6)().length?(0,i.Mq)():(0,i.ZF)(m),s=(0,d.v0)(r),n=(0,c.ad)(r),o=(0,u.cF)(r),l=(0,f.$C)(r,"us-central1")},93448:function(e,t,a){"use strict";a.d(t,{cn:function(){return n}});var r=a(61994),s=a(53335);function n(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,s.m6)((0,r.W)(t))}}},function(e){e.O(0,[4358,9990,2505,6137,1211,9759,3562,6008,9923,2550,1,6313,2578,2765,2971,2117,1744],function(){return e(e.s=11134)}),_N_E=e.O()}]);