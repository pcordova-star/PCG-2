(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3218],{98134:function(e,a,s){Promise.resolve().then(s.bind(s,15983))},15983:function(e,a,s){"use strict";s.r(a),s.d(a,{default:function(){return w}});var l=s(57437),t=s(2265),i=s(99376),r=s(5978),n=s(99764),c=s(71245),o=s(23340),d=s(12381),h=s(79820),u=s(75060),m=s(40279),x=s(23675),p=s(94589),j=s(15291),v=s(53459),g=s(5485),f=s(35465),b=s(44986),N=s(16204),y=s(27316),C=s(60062);function w(){var e,a;let{templateId:s}=(0,i.useParams)(),w=(0,i.useRouter)(),{user:_,companyId:k}=(0,c.a)(),{toast:S}=(0,o.pm)(),[E,I]=(0,t.useState)(null),[O,Z]=(0,t.useState)([]),[z,G]=(0,t.useState)({fecha:new Date().toISOString().slice(0,10),hora:new Date().toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"}),sector:"",elemento:"",actividad:"",responsable:(null==_?void 0:_.displayName)||(null==_?void 0:_.email)||"",observaciones:"",obraId:null}),[P,B]=(0,t.useState)(""),[F,J]=(0,t.useState)(""),[Q,T]=(0,t.useState)({}),[V,A]=(0,t.useState)([]),[U,$]=(0,t.useState)(null),[q,D]=(0,t.useState)(!0),[R,H]=(0,t.useState)(!1),[L,Y]=(0,t.useState)(N.A),[K,M]=(0,t.useState)(N.n);(0,t.useEffect)(()=>{_&&k&&s&&(async()=>{D(!0);try{let e=(0,r.JU)(n.N$,"operationalChecklistTemplates",s),a=await (0,r.QT)(e);if(a.exists()&&a.data().companyId===k)I({id:a.id,...a.data()});else{S({variant:"destructive",title:"Error",description:"Plantilla no encontrada o acceso denegado."}),w.push("/checklists-operacionales/plantillas");return}let l=(0,r.hJ)(n.N$,"obras"),t=(await (0,r.PL)(l)).docs.map(e=>({id:e.id,...e.data()}));Z(t);let i=(0,r.JU)(n.N$,"companyCatalogs",k,"operationalChecklists","config"),c=await (0,r.QT)(i);if(c.exists()){let e=c.data();Y(a=>[...new Set([...a,...e.sectores||[]])].sort()),M(a=>[...new Set([...a,...e.elementos||[]])].sort())}}catch(e){console.error("Error fetching data:",e),S({variant:"destructive",title:"Error",description:"No se pudieron cargar los datos necesarios."})}finally{D(!1)}})()},[s,_,k,w,S]);let W=(e,a)=>{G(s=>({...s,[e]:a}))},X=(e,a)=>{T(s=>({...s,[e]:a}))},ee=e=>{A(a=>a.filter((a,s)=>s!==e))},ea=async()=>{if(_&&k&&E){if(!z.fecha||!z.sector||!z.elemento){S({variant:"destructive",title:"Campos requeridos",description:"Fecha, Sector y Elemento son obligatorios en el encabezado."});return}if(E.secciones){for(let e of E.secciones)for(let a of e.items)if(a.required&&(void 0===Q[a.id]||""===Q[a.id])){S({variant:"destructive",title:"Validaci\xf3n fallida",description:'El campo "'.concat(a.label,'" es obligatorio.')});return}}H(!0);try{let e=[];for(let a of V){let s=(0,C.iH)(n.IG,"operationalChecklists/".concat(k,"/").concat(Date.now(),"_").concat(a.name));await (0,C.KV)(s,a);let l=await (0,C.Jt)(s);e.push(l)}let a=null;if(U){let e=await (await fetch(U)).blob(),s=(0,C.iH)(n.IG,"operationalChecklists/".concat(k,"/firmas/").concat(Date.now(),".png"));await (0,C.KV)(s,e),a=await (0,C.Jt)(s)}let l=(0,r.JU)(n.N$,"companyCatalogs",k,"operationalChecklists","config"),t={};"Otro"===z.sector&&P.trim()&&(t.sectores=(0,r.vr)(P.trim())),"Otro"===z.elemento&&F.trim()&&(t.elementos=(0,r.vr)(F.trim())),Object.keys(t).length>0&&await (0,r.pl)(l,t,{merge:!0});let i={companyId:k,templateId:s,templateTitleSnapshot:E.titulo,obraId:z.obraId,filledByUid:_.uid,filledByEmail:_.email,filledAt:(0,r.Bt)(),header:{...z,sector:"Otro"===z.sector?P.trim():z.sector,elemento:"Otro"===z.elemento?F.trim():z.elemento,evidenceUrls:e},answers:Q,signature:{type:U?"typed":"none",name:z.responsable,dataUrl:a},pdf:{generated:!1},status:"submitted"},c=await (0,r.ET)((0,r.hJ)(n.N$,"operationalChecklistRecords"),i);S({title:"Checklist Guardado",description:"El registro se ha guardado correctamente."}),w.push("/checklists-operacionales/respuestas/".concat(c.id))}catch(e){console.error("Error saving checklist record:",e),S({variant:"destructive",title:"Error",description:"No se pudo guardar el registro."})}finally{H(!1)}}};return q?(0,l.jsxs)("div",{className:"p-8 text-center",children:[(0,l.jsx)(v.Z,{className:"animate-spin"})," Cargando formulario..."]}):E?(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("header",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{className:"flex items-center gap-4",children:[(0,l.jsx)(d.z,{variant:"outline",size:"icon",onClick:()=>w.back(),children:(0,l.jsx)(g.Z,{className:"h-4 w-4"})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h1",{className:"text-2xl font-bold",children:E.titulo}),(0,l.jsx)("p",{className:"text-muted-foreground",children:E.descripcion})]})]}),(0,l.jsxs)(d.z,{onClick:ea,disabled:R,children:[R?(0,l.jsx)(v.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,l.jsx)(f.Z,{className:"mr-2 h-4 w-4"}),R?"Guardando...":"Guardar y Finalizar"]})]}),(0,l.jsxs)(h.Zb,{children:[(0,l.jsx)(h.Ol,{children:(0,l.jsx)(h.ll,{children:"Encabezado"})}),(0,l.jsxs)(h.aY,{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Fecha*"}),(0,l.jsx)(m.I,{type:"date",value:z.fecha,onChange:e=>W("fecha",e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Hora"}),(0,l.jsx)(m.I,{type:"time",value:z.hora,onChange:e=>W("hora",e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Responsable"}),(0,l.jsx)(m.I,{value:z.responsable,onChange:e=>W("responsable",e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Obra (Opcional)"}),(0,l.jsxs)(j.Ph,{value:null!==(a=z.obraId)&&void 0!==a?a:"__none__",onValueChange:e=>W("obraId","__none__"===e?null:e),children:[(0,l.jsx)(j.i4,{children:(0,l.jsx)(j.ki,{placeholder:"Sin Obra Espec\xedfica"})}),(0,l.jsxs)(j.Bw,{children:[(0,l.jsx)(j.Ql,{value:"__none__",children:"Sin Obra Espec\xedfica"}),O.map(e=>(0,l.jsx)(j.Ql,{value:e.id,children:e.nombreFaena},e.id))]})]})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Sector*"}),(0,l.jsxs)(j.Ph,{value:z.sector,onValueChange:e=>W("sector",e),children:[(0,l.jsx)(j.i4,{children:(0,l.jsx)(j.ki,{placeholder:"Seleccionar sector..."})}),(0,l.jsx)(j.Bw,{children:L.map(e=>(0,l.jsx)(j.Ql,{value:e,children:e},e))})]}),"Otro"===z.sector&&(0,l.jsx)(m.I,{value:P,onChange:e=>B(e.target.value),placeholder:"Especificar nuevo sector"})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Elemento*"}),(0,l.jsxs)(j.Ph,{value:z.elemento,onValueChange:e=>W("elemento",e),children:[(0,l.jsx)(j.i4,{children:(0,l.jsx)(j.ki,{placeholder:"Seleccionar elemento..."})}),(0,l.jsx)(j.Bw,{children:K.map(e=>(0,l.jsx)(j.Ql,{value:e,children:e},e))})]}),"Otro"===z.elemento&&(0,l.jsx)(m.I,{value:F,onChange:e=>J(e.target.value),placeholder:"Especificar nuevo elemento"})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(u._,{children:"Actividad/Tarea"}),(0,l.jsx)(m.I,{value:z.actividad,onChange:e=>W("actividad",e.target.value)})]}),(0,l.jsxs)("div",{className:"lg:col-span-3 space-y-2",children:[(0,l.jsx)(u._,{children:"Observaciones Generales"}),(0,l.jsx)(x.g,{value:z.observaciones,onChange:e=>W("observaciones",e.target.value)})]}),(0,l.jsxs)("div",{className:"lg:col-span-3 space-y-2",children:[(0,l.jsx)(u._,{children:"Evidencia Fotogr\xe1fica (opcional)"}),(0,l.jsx)(m.I,{type:"file",accept:"image/*",multiple:!0,onChange:e=>{e.target.files&&A(a=>[...a,...Array.from(e.target.files)])}}),(0,l.jsx)("div",{className:"flex flex-wrap gap-2 mt-2",children:V.map((e,a)=>(0,l.jsxs)("div",{className:"relative text-xs bg-muted p-1 rounded",children:[(0,l.jsx)("span",{children:e.name}),(0,l.jsx)("button",{type:"button",onClick:()=>ee(a),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full h-4 w-4 flex items-center justify-center",children:(0,l.jsx)(b.Z,{size:10})})]},a))})]})]})]}),null===(e=E.secciones)||void 0===e?void 0:e.sort((e,a)=>e.order-a.order).map(e=>(0,l.jsxs)(h.Zb,{children:[(0,l.jsx)(h.Ol,{children:(0,l.jsx)(h.ll,{children:e.title})}),(0,l.jsx)(h.aY,{className:"space-y-4",children:e.items.sort((e,a)=>e.order-a.order).map(e=>{var a;return(0,l.jsxs)("div",{className:"p-4 border rounded-md",children:[(0,l.jsxs)(u._,{className:"font-semibold block mb-2",children:[e.label," ",e.required&&(0,l.jsx)("span",{className:"text-destructive",children:"*"})]}),"boolean"===e.type&&(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(p.r,{checked:Q[e.id]||!1,onCheckedChange:a=>X(e.id,a)}),(0,l.jsx)("span",{children:Q[e.id]?"S\xed / Conforme":"No / No Conforme"})]}),"text"===e.type&&(0,l.jsx)(m.I,{value:Q[e.id]||"",onChange:a=>X(e.id,a.target.value)}),"number"===e.type&&(0,l.jsx)(m.I,{type:"number",value:Q[e.id]||"",onChange:a=>X(e.id,a.target.value)}),"select"===e.type&&(0,l.jsxs)(j.Ph,{value:Q[e.id]||"",onValueChange:a=>X(e.id,a),children:[(0,l.jsx)(j.i4,{children:(0,l.jsx)(j.ki,{placeholder:"Seleccionar..."})}),(0,l.jsx)(j.Bw,{children:null===(a=e.options)||void 0===a?void 0:a.map(e=>(0,l.jsx)(j.Ql,{value:e,children:e},e))})]})]},e.id)})})]},e.id)),(0,l.jsxs)(h.Zb,{children:[(0,l.jsx)(h.Ol,{children:(0,l.jsx)(h.ll,{children:"Firma del Responsable"})}),(0,l.jsxs)(h.aY,{children:[(0,l.jsx)(y.Z,{onChange:$,onClear:()=>$(null)}),(0,l.jsx)("p",{className:"text-xs text-muted-foreground mt-2",children:"Al firmar, doy fe de que la informaci\xf3n registrada es ver\xeddica."})]})]}),(0,l.jsx)("div",{className:"flex justify-end",children:(0,l.jsxs)(d.z,{onClick:ea,disabled:R,children:[R?(0,l.jsx)(v.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,l.jsx)(f.Z,{className:"mr-2 h-4 w-4"}),R?"Guardando...":"Guardar y Finalizar"]})})]}):(0,l.jsx)("div",{className:"p-8 text-center text-destructive",children:"No se pudo cargar la plantilla."})}}},function(e){e.O(0,[4358,9990,6137,1211,9759,3562,6008,9923,2550,2981,7899,2971,2117,1744],function(){return e(e.s=98134)}),_N_E=e.O()}]);