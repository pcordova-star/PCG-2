(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5541],{3257:function(e,r,t){Promise.resolve().then(t.bind(t,94988))},99376:function(e,r,t){"use strict";var a=t(35475);t.o(a,"notFound")&&t.d(r,{notFound:function(){return a.notFound}}),t.o(a,"useParams")&&t.d(r,{useParams:function(){return a.useParams}}),t.o(a,"usePathname")&&t.d(r,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(r,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(r,{useSearchParams:function(){return a.useSearchParams}})},94988:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return h}});var a=t(57437),n=t(2265),s=t(71245),o=t(99376),l=t(5978),i=t(99764),c=t(79820),u=t(33804),d=t(53459);let m={baseMensual:1e5,valorPorUsuario:35e3,currency:"CLP",ufValue:37e3,modulos:{cumplimientoLegal:5e4,analisisPlanosIA:75e3,prevencionRiesgos:6e4,checklists:4e4,controlDocumental:45e3}},f={cumplimientoLegal:"feature_compliance_module_enabled",analisisPlanosIA:"feature_plan_analysis_enabled",prevencionRiesgos:"feature_risk_prevention_enabled",checklists:"feature_operational_checklists_enabled",controlDocumental:"feature_document_control_enabled"};function p(e){return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(e)}function h(){let{role:e,loading:r}=(0,s.a)(),t=(0,o.useRouter)(),h="superadmin"===e,[x,b]=(0,n.useState)([]),[N,j]=(0,n.useState)(m),[g,y]=(0,n.useState)(!0),[v,w]=(0,n.useState)(null);return((0,n.useEffect)(()=>{r||h||t.replace("/dashboard")},[h,r,t]),(0,n.useEffect)(()=>{h&&e();async function e(){y(!0),w(null);try{let e=(0,l.JU)(i.N$,"config","pricing"),r=await (0,l.QT)(e),t=r.exists()?{...m,...r.data()}:m;j(t);let a=(await (0,l.PL)((0,l.hJ)(i.N$,"companies"))).docs.map(e=>({id:e.id,...e.data()})).map(async e=>{let r=(0,l.IO)((0,l.hJ)(i.N$,"users"),(0,l.ar)("empresaId","==",e.id),(0,l.ar)("activo","==",!0)),a=(0,l.IO)((0,l.hJ)(i.N$,"obras"),(0,l.ar)("empresaId","==",e.id)),[n,s]=await Promise.all([(0,l.PL)(r),(0,l.PL)(a)]),o=n.size,c=s.size,u=t.baseMensual+o*t.valorPorUsuario,d=Object.entries(f).reduce((r,a)=>{let[n,s]=a;return e[s]?r+(t.modulos[n]||0):r},0),m=u+d;return{company:e,userCount:o,obraCount:c,costoBaseYUsuarios:u,costoModulos:d,totalSinIvaCLP:m,totalConIvaCLP:1.19*m}}),n=await Promise.all(a);n.sort((e,r)=>(e.company.nombreFantasia||e.company.razonSocial).localeCompare(r.company.nombreFantasia||r.company.razonSocial)),b(n)}catch(e){console.error("Error fetching facturacion data:",e),w("No se pudieron cargar los datos de facturaci\xf3n.")}finally{y(!1)}}},[h]),r||!h)?(0,a.jsx)("div",{className:"flex justify-center items-center h-full p-8",children:(0,a.jsx)(d.Z,{className:"h-8 w-8 animate-spin"})}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("header",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold",children:"Facturaci\xf3n Estimada"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"C\xe1lculo de facturaci\xf3n mensual por empresa basado en los precios globales de la plataforma."})]}),v&&(0,a.jsx)("p",{className:"text-sm font-medium text-destructive",children:v}),(0,a.jsxs)(c.Zb,{children:[(0,a.jsxs)(c.Ol,{children:[(0,a.jsx)(c.ll,{children:"Detalle de Facturaci\xf3n Estimada por Empresa"}),(0,a.jsx)(c.SZ,{children:"Los c\xe1lculos se basan en los precios definidos en el panel de Precios Globales."})]}),(0,a.jsx)(c.aY,{children:(0,a.jsxs)(u.iA,{children:[(0,a.jsx)(u.xD,{children:(0,a.jsxs)(u.SC,{children:[(0,a.jsx)(u.ss,{children:"Empresa"}),(0,a.jsx)(u.ss,{className:"text-center",children:"Usuarios"}),(0,a.jsx)(u.ss,{className:"text-right",children:"Base + Usuarios (CLP)"}),(0,a.jsx)(u.ss,{className:"text-right",children:"M\xf3dulos Premium (CLP)"}),(0,a.jsx)(u.ss,{className:"text-right",children:"Total Neto (CLP)"}),(0,a.jsx)(u.ss,{className:"text-right",children:"Total con IVA (CLP)"})]})}),(0,a.jsx)(u.RM,{children:g?(0,a.jsx)(u.SC,{children:(0,a.jsx)(u.pj,{colSpan:6,className:"text-center h-24",children:(0,a.jsx)(d.Z,{className:"animate-spin mx-auto"})})}):0===x.length?(0,a.jsx)(u.SC,{children:(0,a.jsx)(u.pj,{colSpan:6,className:"text-center h-24",children:"No hay empresas para facturar."})}):x.map(e=>{let{company:r,userCount:t,costoBaseYUsuarios:n,costoModulos:s,totalSinIvaCLP:o,totalConIvaCLP:l}=e;return(0,a.jsxs)(u.SC,{children:[(0,a.jsx)(u.pj,{className:"font-medium",children:r.nombreFantasia||r.razonSocial}),(0,a.jsx)(u.pj,{className:"text-center",children:t}),(0,a.jsx)(u.pj,{className:"text-right",children:p(n)}),(0,a.jsx)(u.pj,{className:"text-right",children:p(s)}),(0,a.jsx)(u.pj,{className:"text-right font-semibold",children:p(o)}),(0,a.jsx)(u.pj,{className:"text-right font-bold text-primary",children:p(l)})]},r.id)})})]})})]})]})}},79820:function(e,r,t){"use strict";t.d(r,{Ol:function(){return l},SZ:function(){return c},Zb:function(){return o},aY:function(){return u},eW:function(){return d},ll:function(){return i}});var a=t(57437),n=t(2265),s=t(93448);let o=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",t),...n})});o.displayName="Card";let l=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",t),...n})});l.displayName="CardHeader";let i=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("text-2xl font-semibold leading-none tracking-tight",t),...n})});i.displayName="CardTitle";let c=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("text-sm text-muted-foreground",t),...n})});c.displayName="CardDescription";let u=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("p-6 pt-0",t),...n})});u.displayName="CardContent";let d=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex items-center p-6 pt-0",t),...n})});d.displayName="CardFooter"},33804:function(e,r,t){"use strict";t.d(r,{RM:function(){return i},SC:function(){return c},iA:function(){return o},pj:function(){return d},ss:function(){return u},xD:function(){return l}});var a=t(57437),n=t(2265),s=t(93448);let o=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{className:"relative w-full overflow-auto",children:(0,a.jsx)("table",{ref:r,className:(0,s.cn)("w-full caption-bottom text-sm",t),...n})})});o.displayName="Table";let l=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("thead",{ref:r,className:(0,s.cn)("[&_tr]:border-b",t),...n})});l.displayName="TableHeader";let i=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("tbody",{ref:r,className:(0,s.cn)("[&_tr:last-child]:border-0",t),...n})});i.displayName="TableBody",n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("tfoot",{ref:r,className:(0,s.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...n})}).displayName="TableFooter";let c=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("tr",{ref:r,className:(0,s.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...n})});c.displayName="TableRow";let u=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("th",{ref:r,className:(0,s.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...n})});u.displayName="TableHead";let d=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("td",{ref:r,className:(0,s.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...n})});d.displayName="TableCell",n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("caption",{ref:r,className:(0,s.cn)("mt-4 text-sm text-muted-foreground",t),...n})}).displayName="TableCaption"},71245:function(e,r,t){"use strict";t.d(r,{H:function(){return m},a:function(){return f}});var a=t(57437),n=t(43301),s=t(2265),o=t(99764),l=t(99376),i=t(5978);async function c(e){var r;let t=o.N$,a=null===(r=e.email)||void 0===r?void 0:r.toLowerCase().trim();if(!a)return{role:"none",companyId:null};let n=(0,i.IO)((0,i.hJ)(t,"invitacionesUsuarios"),(0,i.ar)("email","==",a),(0,i.ar)("estado","==","pendiente_auth"),(0,i.b9)(1)),s=await (0,i.PL)(n);if(s.empty)return console.log("No hay invitaci\xf3n pendiente para ".concat(a,".")),{role:"none",companyId:null};let l=s.docs[0],c=l.data(),u=(0,i.JU)(t,"users",e.uid),d=(0,i.qs)(t);return d.set(u,{nombre:c.nombre||e.displayName,email:a,role:c.roleDeseado,empresaId:c.empresaId,activo:!0,createdAt:(0,i.Bt)(),updatedAt:(0,i.Bt)()},{merge:!0}),d.update(l.ref,{estado:"activado",uid:e.uid,activatedAt:(0,i.Bt)()}),await d.commit(),console.log("Usuario ".concat(a," activado con rol ").concat(c.roleDeseado," en empresa ").concat(c.empresaId,".")),{role:c.roleDeseado,companyId:c.empresaId}}async function u(e){}let d=(0,s.createContext)(void 0);function m(e){let{children:r}=e,[t,m]=(0,s.useState)(null),[f,p]=(0,s.useState)("none"),[h,x]=(0,s.useState)(null),[b,N]=(0,s.useState)(null),[j,g]=(0,s.useState)(!0),y=(0,l.useRouter)(),v=(0,l.usePathname)();async function w(e,r){try{await (0,n.e5)(o.lX,e,r)}catch(e){if("auth/invalid-credential"===e.code||"auth/wrong-password"===e.code||"auth/user-not-found"===e.code)throw Error("Credenciales inv\xe1lidas. Por favor, revisa tu correo y contrase\xf1a.");if("auth/too-many-requests"===e.code)throw Error("Demasiados intentos fallidos. Por seguridad, el acceso desde este dispositivo ha sido bloqueado temporalmente.");throw console.error("Error de login no manejado:",e),Error("Ocurri\xf3 un error inesperado al iniciar sesi\xf3n.")}}async function C(){try{await (0,n.w7)(o.lX),m(null),p("none"),x(null),N(null),y.push("/")}catch(e){console.error("Error al cerrar sesi\xf3n",e)}}return(0,s.useEffect)(()=>{let e=(0,n.Aj)(o.lX,async e=>{if(e){await u(e);let r=(0,i.JU)(o.N$,"users",e.uid),t=await (0,i.QT)(r),a="none",n=null,s=!1;if(t.exists()){let e=t.data();e.role&&void 0!==e.empresaId&&(a=e.role,n=e.empresaId,s=!0===e.mustChangePassword)}if("none"===a){let r=await c(e);a=r.role,n=r.companyId,s=!0}p(a),x(n),m(e);let l="/cambiar-password"===v;if(s&&!l)y.replace("/cambiar-password");else if(!s){if("none"===a)y.replace("/sin-acceso");else if(v.startsWith("/login")||"/"===v||l){let e="cliente"===a?"/cliente":"contratista"===a?"/cumplimiento/contratista":"/dashboard";y.replace(e)}}}else m(null),p("none"),x(null),N(null);g(!1)});return()=>e()},[y,v]),(0,s.useEffect)(()=>{if(h){let e=(0,i.JU)(o.N$,"companies",h),r=(0,n.Aj)(o.lX,r=>{r&&(0,i.QT)(e).then(e=>{e.exists()?N({id:e.id,...e.data()}):N(null)})});return()=>r()}N(null)},[h]),(0,a.jsx)(d.Provider,{value:{user:t,role:f,companyId:h,company:b,loading:j,login:w,logout:C},children:r})}function f(){let e=(0,s.useContext)(d);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}},99764:function(e,r,t){"use strict";let a,n,s,o,l;t.d(r,{IG:function(){return o},N$:function(){return s},lX:function(){return n},x2:function(){return l}});var i=t(738),c=t(43301),u=t(5978),d=t(60062),m=t(13491);let f={apiKey:"AIzaSyBfMp_dH9XhFSXEeMxY-Cdy8MDRIgWrxR0",authDomain:"pcg-2-8bf1b.firebaseapp.com",projectId:"pcg-2-8bf1b",storageBucket:"pcg-2-8bf1b.appspot.com",messagingSenderId:"1073834543546",appId:"1:1073834543546:web:2f85a4a8350280f8589737"};for(let e in f)if(Object.prototype.hasOwnProperty.call(f,e)&&!f[e]){let r=e.replace(/([A-Z])/g,"_$1").toUpperCase(),t="NEXT_PUBLIC_FIREBASE_".concat(r);throw Error("Error de configuraci\xf3n del cliente: La variable de entorno Firebase '".concat(t,"' no est\xe1 definida o est\xe1 vac\xeda. ")+"Aseg\xfarate de que est\xe9 configurada en tu archivo .env.local o en las variables de entorno de producci\xf3n.")}a=(0,i.C6)().length?(0,i.Mq)():(0,i.ZF)(f),n=(0,c.v0)(a),s=(0,u.ad)(a),o=(0,d.cF)(a),l=(0,m.$C)(a,"us-central1")},93448:function(e,r,t){"use strict";t.d(r,{cn:function(){return s}});var a=t(61994),n=t(53335);function s(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,n.m6)((0,a.W)(r))}},96471:function(e,r,t){"use strict";t.d(r,{Z:function(){return i}});var a=t(2265);let n=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),s=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.filter((e,r,t)=>!!e&&""!==e.trim()&&t.indexOf(e)===r).join(" ").trim()};var o={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let l=(0,a.forwardRef)((e,r)=>{let{color:t="currentColor",size:n=24,strokeWidth:l=2,absoluteStrokeWidth:i,className:c="",children:u,iconNode:d,...m}=e;return(0,a.createElement)("svg",{ref:r,...o,width:n,height:n,stroke:t,strokeWidth:i?24*Number(l)/Number(n):l,className:s("lucide",c),...m},[...d.map(e=>{let[r,t]=e;return(0,a.createElement)(r,t)}),...Array.isArray(u)?u:[u]])}),i=(e,r)=>{let t=(0,a.forwardRef)((t,o)=>{let{className:i,...c}=t;return(0,a.createElement)(l,{ref:o,iconNode:r,className:s("lucide-".concat(n(e)),i),...c})});return t.displayName="".concat(e),t}},53459:function(e,r,t){"use strict";t.d(r,{Z:function(){return a}});let a=(0,t(96471).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])}},function(e){e.O(0,[4358,9990,6137,1211,2971,2117,1744],function(){return e(e.s=3257)}),_N_E=e.O()}]);