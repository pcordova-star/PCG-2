"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7974],{97974:function(e,a,t){t.d(a,{Z:function(){return N}});var r=t(57437),s=t(2265),i=t(71245),n=t(99764),d=t(12381),l=t(79820),c=t(40279),o=t(75060),u=t(15291),m=t(44986),f=t(53459),x=t(23340),p=t(73367),h=t(33804),j=t(5978),b=t(13838);function N(e){let{obraId:a,obras:t=[],actividades:N,onAvanceRegistrado:v,allowObraSelection:g=!1,onObraChanged:y}=e,{user:w}=(0,i.a)(),{toast:C}=(0,x.pm)(),[A,R]=(0,s.useState)(a||(t.length>0?t[0].id:"")),[S,F]=(0,s.useState)(new Date().toISOString().slice(0,10)),[I,_]=(0,s.useState)({}),[k,T]=(0,s.useState)({}),[D,Z]=(0,s.useState)({}),E=(0,s.useMemo)(()=>N.filter(e=>e.obraId===A),[N,A]),{avancesPorActividad:z}=(0,p.n)(A,E),[M,O]=(0,s.useState)(!1),[J,P]=(0,s.useState)(null);(0,s.useEffect)(()=>{a&&R(a)},[a]);let B=()=>{_({}),T({}),Z({}),P(null)},G=(e,a)=>{if(!a.target.files)return;let t=Array.from(a.target.files),r=[],s=!1;for(let e of t)e.type.includes("heic")||e.type.includes("heif")||/\.heic$/i.test(e.name)||/\.heif$/i.test(e.name)?s=!0:r.push(e);s&&(C({variant:"destructive",title:"Formato de imagen no compatible",description:"Las fotos en formato HEIC (de iPhone) no son soportadas. Por favor, cambia la configuraci\xf3n de tu c\xe1mara a 'M\xe1s compatible' (JPG) en Ajustes > C\xe1mara > Formatos.",duration:8e3}),a.target.value=""),r.length>0&&Z(a=>{let t=a[e]||[];return t.length+r.length>5?(P("No m\xe1s de ".concat(5," fotos por actividad.")),C({variant:"destructive",title:"L\xedmite de fotos excedido"}),a):{...a,[e]:[...t,...r]}})},H=(e,a)=>{Z(t=>{var r;return{...t,[e]:(null===(r=t[e])||void 0===r?void 0:r.filter((e,t)=>t!==a))||[]}})},$=async e=>{if(e.preventDefault(),!A||!w){P("Debes seleccionar una obra y estar autenticado.");return}let a=Object.entries(I).filter(e=>{let[a,t]=e;return Number.isFinite(t)&&t>0});if(0===a.length){P('No hay cantidades para registrar. Ingresa un valor en "Cantidad de Hoy" para al menos una actividad.');return}O(!0),P(null);try{let e=n.N$,t=0;for(let[r,s]of a){let a=E.find(e=>e.id===r);if(!a)continue;let i=[];if(D[r]&&D[r].length>0)for(let e of D[r]){let a="".concat(Date.now(),"-").concat(e.name),t="avances/".concat(A,"/").concat(a),r=await (0,b.v)(e,t);i.push(r)}let n=(0,j.JU)(e,"obras",A),d=(0,j.hJ)(n,"avancesDiarios"),l=(0,j.JU)(d);await (0,j.i3)(e,async t=>{let d=await t.get(n);if(!d.exists())throw Error("La obra no existe.");let c={obraId:A,actividadId:r,fecha:new Date(S+"T12:00:00Z"),cantidadEjecutada:s,unidad:a.unidad||"",porcentajeAvance:s/(a.cantidad||1)*100,comentario:k[r]||"",fotos:i,visibleCliente:!0,tipoRegistro:"CANTIDAD",creadoPor:{uid:w.uid,displayName:w.displayName||w.email},createdAt:(0,j.Bt)()};t.set(l,c);let o=d.data(),u=(await (0,j.PL)((0,j.hJ)(e,"obras",A,"actividades"))).size;if(u>0&&a.cantidad>0){let e=E.reduce((e,a)=>e+(a.cantidad||0)*(a.precioContrato||0),0),r=e>0?a.cantidad*a.precioContrato/e:1/u,i=s/a.cantidad*r*100;if(!isNaN(i)&&i>0){let e=Math.min(100,(o.avanceAcumulado||0)+i);t.update(n,{avanceAcumulado:e,ultimaActualizacion:(0,j.Bt)()})}}}),t++}t>0&&(C({title:"Avance registrado con \xe9xito",description:"Se guardaron ".concat(t," registros de avance.")}),v&&v(a),B())}catch(e){P(e.message),C({variant:"destructive",title:"Error al registrar",description:e.message,duration:1e4})}finally{O(!1)}};return(0,r.jsxs)(l.Zb,{children:[(0,r.jsxs)(l.Ol,{children:[(0,r.jsx)(l.ll,{children:"Registro de Avance por Cantidad"}),(0,r.jsx)(l.SZ,{children:"Seleccione la obra e ingrese las cantidades ejecutadas para cada actividad."})]}),(0,r.jsx)(l.aY,{children:(0,r.jsxs)("form",{onSubmit:$,className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 sm:items-end mb-6",children:[g&&(0,r.jsxs)("div",{className:"space-y-1 flex-grow",children:[(0,r.jsx)(o._,{htmlFor:"obra-selector",className:"text-xs font-medium",children:"Obra*"}),(0,r.jsxs)(u.Ph,{value:A,onValueChange:e=>{R(e),B(),y&&y(e)},required:!0,children:[(0,r.jsx)(u.i4,{id:"obra-selector",children:(0,r.jsx)(u.ki,{placeholder:"Seleccionar obra"})}),(0,r.jsx)(u.Bw,{children:t.map(e=>(0,r.jsx)(u.Ql,{value:e.id,children:e.nombreFaena},e.id))})]})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o._,{htmlFor:"avance-fecha",className:"text-xs font-medium",children:"Fecha de Avance*"}),(0,r.jsx)(c.I,{id:"avance-fecha",type:"date",value:S,onChange:e=>F(e.target.value),required:!0})]})]}),(0,r.jsx)("div",{className:"overflow-x-auto border rounded-lg",children:(0,r.jsxs)(h.iA,{children:[(0,r.jsx)(h.xD,{children:(0,r.jsxs)(h.SC,{children:[(0,r.jsx)(h.ss,{className:"w-[25%]",children:"Actividad"}),(0,r.jsx)(h.ss,{children:"Total"}),(0,r.jsx)(h.ss,{children:"Acumulado"}),(0,r.jsx)(h.ss,{className:"w-[120px]",children:"Cant. de Hoy"}),(0,r.jsx)(h.ss,{children:"Nuevo %"}),(0,r.jsx)(h.ss,{children:"Comentario / Foto"})]})}),(0,r.jsx)(h.RM,{children:E.length>0?E.map(e=>{let a=z[e.id]||{cantidadAcumulada:0,porcentajeAcumulado:0},t=I[e.id]||0,s=a.cantidadAcumulada+t,i=Number(e.cantidad),n=Number.isFinite(i)&&i>0?s/i*100:NaN,d=e.cantidad?Math.max(0,e.cantidad-a.cantidadAcumulada):0;return(0,r.jsxs)(h.SC,{children:[(0,r.jsx)(h.pj,{className:"font-medium text-xs",children:e.nombreActividad}),(0,r.jsxs)(h.pj,{className:"text-xs",children:[e.cantidad||0," ",e.unidad]}),(0,r.jsxs)(h.pj,{className:"text-xs font-semibold",children:[a.cantidadAcumulada.toFixed(2)," (",a.porcentajeAcumulado.toFixed(1),"%)"]}),(0,r.jsxs)(h.pj,{children:[(0,r.jsx)(c.I,{type:"number",placeholder:"0",value:I[e.id]||"",onChange:a=>{let t=parseFloat(a.target.value);_(a=>({...a,[e.id]:Number.isFinite(t)?t:0}))},className:"h-8 text-xs"}),(0,r.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:["Disponible: ",d.toFixed(2)]})]}),(0,r.jsx)(h.pj,{className:"text-xs font-bold text-primary",children:Number.isFinite(n)?"".concat(Math.min(100,n).toFixed(1),"%"):"N/A"}),(0,r.jsxs)(h.pj,{className:"w-[250px] space-y-2",children:[(0,r.jsx)(c.I,{type:"text",placeholder:"Comentario...",value:k[e.id]||"",onChange:a=>T(t=>({...t,[e.id]:a.target.value})),className:"h-8 text-xs"}),(0,r.jsx)(c.I,{type:"file",accept:"image/*",capture:"environment",multiple:!0,onChange:a=>G(e.id,a),className:"h-8 text-xs"}),(0,r.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:(D[e.id]||[]).map((a,t)=>(0,r.jsxs)("div",{className:"relative text-xs bg-muted p-1 rounded",children:[(0,r.jsxs)("span",{children:[a.name.substring(0,10),"..."]}),(0,r.jsx)("button",{type:"button",onClick:()=>H(e.id,t),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full h-4 w-4 flex items-center justify-center text-white",children:(0,r.jsx)(m.Z,{size:10})})]},t))})]})]},e.id)}):(0,r.jsx)(h.SC,{children:(0,r.jsx)(h.pj,{colSpan:6,className:"h-24 text-center text-muted-foreground",children:"No hay actividades programadas para la obra seleccionada."})})})]})}),J&&(0,r.jsx)("p",{className:"text-sm font-medium text-destructive",children:J}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)(d.z,{type:"submit",disabled:M||!A,children:[M&&(0,r.jsx)(f.Z,{className:"mr-2 h-4 w-4 animate-spin"}),M?"Guardando...":"Registrar Avances del D\xeda"]}),(0,r.jsx)(d.z,{type:"button",variant:"ghost",onClick:()=>{},children:"Cancelar"})]})]})})]})}},73367:function(e,a,t){t.d(a,{n:function(){return n}});var r=t(2265),s=t(5978),i=t(99764);function n(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],[t,n]=(0,r.useState)([]),[d,l]=(0,r.useState)(!0),[c,o]=(0,r.useState)(null),u=(0,r.useCallback)(()=>{if(!e){n([]),l(!1);return}l(!0);let a=(0,s.hJ)(i.N$,"obras",e,"avancesDiarios"),t=(0,s.IO)(a,(0,s.Xo)("fecha","desc"));return(0,s.cf)(t,e=>{n(e.docs.map(e=>({id:e.id,...e.data()}))),l(!1)},e=>{console.error("Error fetching avances: ",e),o("No se pudieron cargar los avances."),l(!1)})},[e]);(0,r.useEffect)(()=>{let e=u();return()=>null==e?void 0:e()},[u]);let m=(0,r.useMemo)(()=>{let e={};if(!a)return e;let r=t.filter(e=>"FOTOGRAFICO"!==e.tipoRegistro&&"number"==typeof e.cantidadEjecutada),s={};for(let e of r)e.actividadId&&(s[e.actividadId]||(s[e.actividadId]=0),s[e.actividadId]+=Number(e.cantidadEjecutada||0));for(let t of a){let a=s[t.id]||0,r=t.cantidad>0?a/t.cantidad*100:0;e[t.id]={cantidadAcumulada:a,porcentajeAcumulado:Math.min(100,r)}}return e},[t,a]);return{avances:t,avancesPorActividad:m,loading:d,error:c,refetchAvances:u}}},15291:function(e,a,t){t.d(a,{Bw:function(){return p},Ph:function(){return o},Ql:function(){return h},i4:function(){return m},ki:function(){return u}});var r=t(57437),s=t(2265),i=t(74797),n=t(3289),d=t(47969),l=t(59559),c=t(93448);let o=i.fC;i.ZA;let u=i.B4,m=s.forwardRef((e,a)=>{let{className:t,children:s,...d}=e;return(0,r.jsxs)(i.xz,{ref:a,className:(0,c.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",t),...d,children:[s,(0,r.jsx)(i.JO,{asChild:!0,children:(0,r.jsx)(n.Z,{className:"h-4 w-4 opacity-50"})})]})});m.displayName=i.xz.displayName;let f=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)(i.u_,{ref:a,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",t),...s,children:(0,r.jsx)(d.Z,{className:"h-4 w-4"})})});f.displayName=i.u_.displayName;let x=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)(i.$G,{ref:a,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",t),...s,children:(0,r.jsx)(n.Z,{className:"h-4 w-4"})})});x.displayName=i.$G.displayName;let p=s.forwardRef((e,a)=>{let{className:t,children:s,position:n="popper",...d}=e;return(0,r.jsx)(i.h_,{children:(0,r.jsxs)(i.VY,{ref:a,className:(0,c.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===n&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:n,...d,children:[(0,r.jsx)(f,{}),(0,r.jsx)(i.l_,{className:(0,c.cn)("p-1","popper"===n&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),(0,r.jsx)(x,{})]})})});p.displayName=i.VY.displayName,s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)(i.__,{ref:a,className:(0,c.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...s})}).displayName=i.__.displayName;let h=s.forwardRef((e,a)=>{let{className:t,children:s,...n}=e;return(0,r.jsxs)(i.ck,{ref:a,className:(0,c.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...n,children:[(0,r.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,r.jsx)(i.wU,{children:(0,r.jsx)(l.Z,{className:"h-4 w-4"})})}),(0,r.jsx)(i.eT,{children:s})]})});h.displayName=i.ck.displayName,s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)(i.Z0,{ref:a,className:(0,c.cn)("-mx-1 my-1 h-px bg-muted",t),...s})}).displayName=i.Z0.displayName},33804:function(e,a,t){t.d(a,{RM:function(){return l},SC:function(){return c},iA:function(){return n},pj:function(){return u},ss:function(){return o},xD:function(){return d}});var r=t(57437),s=t(2265),i=t(93448);let n=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("div",{className:"relative w-full overflow-auto",children:(0,r.jsx)("table",{ref:a,className:(0,i.cn)("w-full caption-bottom text-sm",t),...s})})});n.displayName="Table";let d=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("thead",{ref:a,className:(0,i.cn)("[&_tr]:border-b",t),...s})});d.displayName="TableHeader";let l=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("tbody",{ref:a,className:(0,i.cn)("[&_tr:last-child]:border-0",t),...s})});l.displayName="TableBody",s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("tfoot",{ref:a,className:(0,i.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...s})}).displayName="TableFooter";let c=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("tr",{ref:a,className:(0,i.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...s})});c.displayName="TableRow";let o=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("th",{ref:a,className:(0,i.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...s})});o.displayName="TableHead";let u=s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("td",{ref:a,className:(0,i.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...s})});u.displayName="TableCell",s.forwardRef((e,a)=>{let{className:t,...s}=e;return(0,r.jsx)("caption",{ref:a,className:(0,i.cn)("mt-4 text-sm text-muted-foreground",t),...s})}).displayName="TableCaption"},13838:function(e,a,t){t.d(a,{v:function(){return i}});var r=t(99764),s=t(60062);async function i(e,a){let t=(0,s.iH)(r.IG,a);return await (0,s.KV)(t,e,{contentType:e.type||"application/octet-stream",cacheControl:"public,max-age=3600"}),await (0,s.Jt)(t)}}}]);