rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------- Helpers ---------
    function isSignedIn() {
      return request.auth != null;
    }

    function getRole() {
      return isSignedIn() ? request.auth.token.role : null;
    }

    function getAuthCompanyId() {
      return isSignedIn() ? request.auth.token.companyId : null;
    }
    
    function getAuthEmail() {
      return isSignedIn() ? request.auth.token.email : null;
    }

    // --------- Regla para invitacionesUsuarios ---------
    match /invitacionesUsuarios/{inviteId} {
      allow create: if getRole() == 'superadmin' || getRole() == 'admin_empresa';

      allow read, update, delete: if 
        getRole() == 'superadmin' ||
        (getAuthCompanyId() == resource.data.empresaId) ||
        (getAuthEmail() == resource.data.emailInvitado);
    }

    // --------- Reglas ultra abiertas para el resto (desarrollo) ---------
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
