rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------- Helpers ---------
    function isSignedIn() {
      return request.auth != null;
    }

    function getRole() {
      return isSignedIn() ? request.auth.token.role : null;
    }

    function isSuperadmin() {
      return getRole() == "superadmin";
    }
    
    function isAdminEmpresa() {
      return getRole() == "admin_empresa";
    }

    function getAuthCompanyId() {
      return isSignedIn() ? request.auth.token.companyId : null;
    }
    
    function getAuthEmail() {
      return isSignedIn() ? request.auth.token.email : null;
    }

    // --------- Regla para invitacionesUsuarios ---------
    match /invitacionesUsuarios/{inviteId} {
      allow create: if isSuperadmin() || isAdminEmpresa();

      allow read, update, delete: if 
        isSuperadmin() ||
        (getAuthCompanyId() == resource.data.empresaId) ||
        (getAuthEmail() == resource.data.emailInvitado);
    }
    
    // Documentos corporativos (empresa)
    match /companyDocuments/{docId} {
      allow read: if isSignedIn() && getAuthCompanyId() == resource.data.companyId;
      allow write: if isAdminEmpresa() || isSuperadmin();
    }

    // Documentos de proyecto
    match /projectDocuments/{docId} {
      allow read: if isSignedIn() && getAuthCompanyId() == resource.data.companyId;
      allow write: if isAdminEmpresa() || isSuperadmin();
    }

    // Distribuci√≥n (ISO)
    match /documentDistribution/{docId} {
      allow read: if isSignedIn() && getAuthCompanyId() == resource.data.companyId;
      allow write: if isSuperadmin() || isAdminEmpresa(); // solo backend normalmente
    }


    // --------- Reglas ultra abiertas para el resto (desarrollo) ---------
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
